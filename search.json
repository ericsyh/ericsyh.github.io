[{"title":"Win10 ä½¿ç”¨ Kind éƒ¨ç½² Kubernetes","url":"/2020/11/01/Win10-ä½¿ç”¨-Kind-éƒ¨ç½²-Kubernetes/","content":"\n## èƒŒæ™¯\nWin10 çš„ WSL2 æ”¯æ’‘äº†åœ¨ Linux å­ç³»ç»Ÿä¸­ä½¿ç”¨ Dockerï¼Œå°è¯•åœ¨ WSL2 ç¯å¢ƒä¸‹é€šè¿‡ [Kind](https://github.com/kubernetes-sigs/kind) æ¥éƒ¨ç½²æœ¬åœ° Kubernetes ç¯å¢ƒã€‚\n\n## æ“ä½œæ­¥éª¤\n\n### WSL2 å®‰è£…\nè¯¦ç»†æ–‡æ¡£å‚è€ƒ [Installation Instructions for WSL2](https://docs.microsoft.com/en-us/windows/wsl/install-win10)\n1. åœ¨Windowsç¨‹åºä¸­ï¼Œé€‰æ‹©å¯ç”¨ \"é€‚ç”¨äº Linux çš„ Windows å­ç³»ç»Ÿ\"\n2. ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ PowerShell å¹¶è¿è¡Œ `dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart`\n3. ç®¡ç†å‘˜èº«ä»½æ‰“å¼€ PowerShell å¹¶è¿è¡Œ `wsl --set-default-version 2`\n4. æ‰“å¼€ Microsoft Storeï¼Œå¹¶é€‰æ‹©è‡ªå·±åå¥½çš„ Linux åˆ†å‘ç‰ˆ\n\n### Docker-desktop å®‰è£…\næ–‡æ¡£å‚è€ƒ [docker-for-windows](https://docs.docker.com/docker-for-windows/wsl/) è¿›è¡Œ Win10 Docker-desktop å®‰è£…\n\n### Kind å®‰è£…\n1. è¿›å…¥ Win10 çš„ Linux å­ç³»ç»Ÿï¼Œåœ¨å­ç³»ç»Ÿå†…å®‰è£… Kind binary\n```\ncurl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64\nchmod +x ./kind\nmv ./kind /some-dir-in-your-PATH/kind\n```\n2. å‡†å¤‡ Kind æ‰€éœ€çš„ kindest/node é•œåƒ `docker pull kindest/node:v1.19.1`\n3. ä½¿ç”¨ Kind å‘½ä»¤åˆ›å»ºæœ¬åœ° Kubernetes `kind create cluster`\n```\nCreating cluster \"kind\" ...\n âœ“ Ensuring node image (kindest/node:v1.19.1) ğŸ–¼\n âœ“ Preparing nodes ğŸ“¦\n âœ“ Writing configuration ğŸ“œ\n âœ“ Starting control-plane ğŸ•¹ï¸\n âœ“ Installing CNI ğŸ”Œ\n âœ“ Installing StorageClass ğŸ’¾\nSet kubectl context to \"kind-kind\"\nYou can now use your cluster with:\n\nkubectl cluster-info --context kind-kind\n\nThanks for using kind! ğŸ˜Š\n```\n4. ä½¿ç”¨ kubectl éƒ¨ç½² deployment `kubectl create deployment nginx --image=nginx`\n```\nNAME    READY   UP-TO-DATE   AVAILABLE   AGE\nnginx   1/1     1            0           63s\n```","tags":["Kubernetes","Kind"]},{"title":"Confluence Server æ•°æ®åº“è¿ç§» from H2 to MySQL","url":"/2020/06/22/Confluence-Server-æ•°æ®åº“è¿ç§»-from-H2-to-MySQL/","content":"\n## èƒŒæ™¯\nä¹‹å‰æŒ‰ç…§ [Dockerå®‰è£…Confluence](https://www.jianshu.com/p/8e81caca5f2a) éƒ¨ç½²äº† confluence serverã€‚å‰æœŸä¸ºäº†æ–¹ä¾¿ç›´æ¥ä½¿ç”¨äº† confluence å†…åµŒçš„ H2 æ•°æ®åº“ã€‚åç»­å°ä¼™ä¼´é™†é™†ç»­ç»­å¼€å§‹ä½¿ç”¨èµ·æ¥åï¼Œä¸ºäº†ç¨³å®šè¿˜æ˜¯æŒ‰ç…§å®˜æ–¹è¦æ±‚ä½¿ç”¨å¤–éƒ¨æ•°æ®åº“ï¼Œå¹¶å°†ç°æœ‰çš„æ•°æ®è¿›è¡Œè¿ç§»ã€‚\n\n## æ“ä½œæ­¥éª¤\n### å¤‡ä»½ confluence \n1. ä½¿ç”¨ç®¡ç†å‘˜è´¦å·è¿›å…¥ **ç«™ç‚¹ç®¡ç†** -> **ä¸€èˆ¬é…ç½®** -> **å¤‡ä»½ä¸è¿˜åŸ**ï¼Œå¯¹å½“å‰ confluence è¿›è¡Œå¤‡ä»½æ“ä½œ\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/18/172c6bd9e19dc5ad?f=png&s=63731\" width=\"648\" height=\"286\" />\n</div>\n\nå¤‡ä»½å®Œæˆåï¼Œä¼šåœ¨å®¹å™¨ `/var/atlassian/confluence/backups/` ç›®å½•ä¸‹ç”Ÿæˆç›¸åº”çš„å¤‡ä»½æ–‡ä»¶\n\n2. æ‰§è¡Œ `docker cp 8172e44b0b61:/var/atlassian/confluence/backups/xmlexport-20200619-051237-3.zip /home/confluence` å‘½ä»¤å°†ç«™ç‚¹å¤‡ä»½æ–‡ä»¶ä»å®¹å™¨ä¸­æ‹·è´è‡³ä¸»æœºç›®å½•ä¸‹\n\n### å®‰è£… MySQL\näº²æµ‹ MySQL 8.0 ä¸æ”¯æŒï¼Œæœ€åé€‰ç”¨ MySQL 5.7ï¼Œæä¾›ä¸¤ç§æ–¹å¼è¿›è¡Œéƒ¨ç½²\n\n#### Host éƒ¨ç½² MySQL\n1. ç›´æ¥ apt å®‰è£… MySQL `sudo apt-get install mysql-server`\n2. è¿›è¡Œ MySQL çš„åˆå§‹åŒ– `sudo mysql_secure_installation`\n3. è¿›å…¥ MySQL ç»ˆç«¯ï¼Œåˆ›å»º confluence åº“å’Œç”¨æˆ·å¹¶ä¸”æˆæƒ\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n\n4. ä¿®æ”¹ MySQL é…ç½®æ–‡ä»¶ \n\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n\né‡å¯ MySQL `systemctl restart mysql`\n\n#### Docker éƒ¨ç½² MySQL\n1. æ‹‰å– MySQL é•œåƒ `docker pull mysql:5.7`\n2. åˆ›å»º MySQL å®¹å™¨ `docker run -p 3306:3306 --name mysql -v /data/mysql:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=<password> -d mysql:5.7`\n3. è¿›å…¥å®¹å™¨ä¿®æ”¹é…ç½® `docker exec -it mysql /bin/bash`\n4. åˆ›å»º confluence åº“å’Œç”¨æˆ·å¹¶ä¸”æˆæƒ\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n5.ä¿®æ”¹ MySQL é…ç½®æ–‡ä»¶\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n6. é‡å¯ MySQL å®¹å™¨ `docker restart mysql`\n\n### éƒ¨ç½²æ–°çš„ confluence\n1. å°†ä¹‹å‰çš„ confluence å®¹å™¨åœæ­¢ `docker stop 8172e44b0b61`\n2. åˆ›å»ºæ–°çš„ confluence å®¹å™¨ `docker run -d -v /data/conflunece:/var/atlassian/confluence --name confluence -p 8090:8090 --user root:root cptactionhank/atlassian-confluence:latest `\n3. é€‰æ‹©ä½¿ç”¨éå†…ç½®æ•°æ®åº“\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf145a3b81231?f=png&s=63589\" width=\"603\" height=\"328\" />\n</div>\n\n4. é…ç½®æ•°æ®åº“è¿æ¥\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf1a5de0831bc?f=png&s=71044\" width=\"606\" height=\"400\" />\n</div>\n\n### æ•°æ®è¿ç§»\n1. åœ¨**åŠ è½½å†…å®¹** é¡µé€‰æ‹© **ä»å¤‡ä»½è¿˜åŸ**\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf21da53ad4ec?f=png&s=88344\" width=\"606\" height=\"416\" />\n</div>\n\n2. å°†ä¹‹å‰ç«™ç‚¹å¤‡ä»½æ–‡ä»¶å¯¼å…¥ `cp /home/confluence/xmlexport-20200619-051237-3.zip /data/conflunece/restore/`\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf24a1e450e1d?f=png&s=40713\" width=\"609\" height=\"220\" />\n</div>\n\n3. ç­‰å¾…æ•°æ®è¿˜åŸ\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf255a3a21f5b?f=png&s=35665\" width=\"607\" height=\"270\" />\n</div>\n\n4. æ¢å¤å®Œæˆ\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf2ceba712728?f=png&s=22243\" width=\"606\" height=\"203\" />\n</div>\n","tags":["Confluence","Docker"]},{"title":"kubeadm åˆæ¢","url":"/2020/01/06/kubeadm-åˆæ¢/","content":"\nä½¿ç”¨ kubeadm å®‰è£… k8s é›†ç¾¤æ­¥éª¤æ•´ç†ã€‚\n\n## ç¤ºä¾‹æœåŠ¡å™¨å‡†å¤‡\n\nAzure VM ä¸Šåˆ›å»ºä¸‰å° centos 7.5 æœåŠ¡å™¨åˆ†åˆ«ä½œä¸º k8s master å’Œ k8s workerï¼š\n\n```\nmaster: 207.46.156.242\nworker1: 207.46.151.202\nworker2: 168.63.140.91\n```\n\n## æ“ä½œæ­¥éª¤\n### å®‰è£… Docker\n\n#### å®‰è£…ç›¸å…³ä¾èµ–\n\n```\nsudo yum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n```\n#### æ·»åŠ  Docker ä»“åº“\n\n```\nsudo yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n#### å®‰è£… Docker \n\n```\nsudo yum install docker-ce docker-ce-cli containerd.io\n```\n\n#### å¯åŠ¨ Docker\n\n```\nsudo systemctl start docker\n\nsudo systemctl enable docker\n```\n\n### å®‰è£… kubeadm\n\n#### å®‰è£… kubeadm , kubelet , kubectl\n\n```\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n\n# Set SELinux in permissive mode (effectively disabling it)\nsetenforce 0\nsed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\nyum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n\nsystemctl enable --now kubelet\n```\n\n#### ä¿®æ”¹ Docker cgroups å¯åŠ¨\n\nåˆ›å»º `/etc/docker/daemon.json` æ–‡ä»¶ï¼ŒåŠ å…¥ä»¥ä¸‹å†…å®¹\n\n```\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\n```\né‡å¯ Docker\n\n```\nsystemctl restart docker\n```\n\næŸ¥çœ‹ä¿®æ”¹åçŠ¶æ€\n\n```\ndocker info | grep Cgroup\n\nCgroup Driver: systemd\n```\n\n#### é…ç½® bridge \n\n```\necho 1 > /proc/sys/net/bridge/bridge-nf-call-iptables\necho 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables\n```\n\n### ä½¿ç”¨ kubeadm éƒ¨ç½² k8s é›†ç¾¤\n\n#### master èŠ‚ç‚¹\n\n##### æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤\n\n```\nkubeadm init\n```\n\n##### è®°å½• join å‚æ•°å‘½ä»¤\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\n##### æ‰§è¡Œé›†ç¾¤é…ç½®å‘½ä»¤\n\n```\nmkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n##### éƒ¨ç½²ç½‘ç»œæ’ä»¶\n\n```\nkubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n```\n\n#### worker èŠ‚ç‚¹\n\nåˆ†åˆ«æ‰§è¡Œ join å‘½ä»¤\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\nåœ¨ master èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹ node çŠ¶æ€\n\n```\nkubectl get nodes\n\nNAME       STATUS   ROLES    AGE     VERSION\nmaster     Ready    master   8m45s   v1.17.0\nworker01   Ready    <none>   2m31s   v1.17.0\nworker02   Ready    <none>   2m23s   v1.17.0\n```\n\n\n\n\n\n\n","tags":["k8s","kubeadm"]},{"title":"MySQL Binlog Replication","url":"/2020/01/05/MySQL-Binlog-Replication/","content":"\nMySQL å¼€å¯ binlog é…ç½®ä¸»ä»åŒæ­¥æ­¥éª¤æ•´ç†ã€‚\n\n\n## ç¤ºä¾‹æœåŠ¡å™¨å‡†å¤‡\n\nAzure VM ä¸Šåˆ›å»ºä¸¤å° centos 7.5 æœåŠ¡å™¨åˆ†åˆ«ä½œä¸º MySQL master å’Œ My SQL slaveï¼š\n\n* master: 13.75.108.150\n* slave: 13.75.109.41\n\n## æ“ä½œæ­¥éª¤\n### å®‰è£… MySQL \n#### æ·»åŠ  MySQL 5.7ä»“åº“\n\n```\nsudo rpm -ivh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm\n```\n\n#### å®‰è£… MySQL 5.7\n\n```\nsudo yum -y install mysql-community-server\n```\n\n#### MySQL æœåŠ¡é…ç½®\n\n##### å¯åŠ¨ MySQL æœåŠ¡\n\n```\nsudo systemctl start mysqld\n```\n\n##### è®¾ç½®å¼€å¯è‡ªå¯\n\n```\nsudo systemctl enable mysqld\n```\n\n#### å®‰å…¨è®¾ç½®\n\n##### è·å– MySQL ä¸´æ—¶å¯†ç \n\n```\ncat /var/log/mysqld.log | grep -i 'temporary password'\n```\n\n##### é…ç½®å®‰å…¨è®¾ç½®\n\n```\nmysql_secure_installation\n```\n\n### é…ç½® binlog ä¸»ä»åŒæ­¥\n\n#### master æœåŠ¡å™¨é…ç½®\n\n##### åˆ›å»ºåŒæ­¥ç”¨æˆ·\n\n```\nmysql> CREATE USER 'slave'@'%' IDENTIFIED BY '{YOUR PASSWORD}';\n\nmysql> GRANT ALL PRIVILEGES ON *.* TO slave@\"%\" IDENTIFIED BY \"{YOUR PASSWORD}\";\n```\n\n##### å¼€å¯ binlog\n\nä¿®æ”¹ `/etc/my.cnf` æ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹å¦‚ä¸‹ï¼š\n\n```\nlog-bin=mysql-bin\nserver-id=10\n```\n\né‡å¯ MySQL æœåŠ¡ï¼š\n\n```\nsystemctl restart mysqld.service\n```\n\n##### è·å–åˆå§‹åŒæ­¥ä½ç½®\n\n```\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |      154 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n```\n\n#### slave æœåŠ¡å™¨é…ç½®\n\n##### ä¿®æ”¹ MySQL é…ç½®\n\nä¿®æ”¹ `/etc/my.cnf` æ–‡ä»¶ï¼Œæ·»åŠ å†…å®¹å¦‚ä¸‹ï¼š\n\n```\nserver-id=12\nreplicate-do-db=test\nskip-slave-start=true\n```\n\né‡å¯ MySQL æœåŠ¡ï¼š\n\n```\nsystemctl restart mysqld.service\n```\n\n##### é…ç½®ä¸»ä»åŒæ­¥\n\nåœæ­¢ slave æœåŠ¡è¿›ç¨‹ï¼š\n\n```\nmysql> stop slave;\n```\n\né…ç½®åŒæ­¥ä¸Šæ¸¸ä¿¡æ¯ï¼š\n\n```\nmysql> change master to \nmaster_host='13.75.108.150',\nmaster_user='slave',\nmaster_password='{YOUR PASSWORD}',\nmaster_log_file='mysql-bin.000001', \nmaster_log_pos=313;\n```\n\nå¼€å¯ slave æœåŠ¡è¿›ç¨‹ï¼š\n\n```\nmysql> start slave;\n```\n\næŸ¥çœ‹ slave åŒæ­¥çŠ¶æ€ï¼š\n\n```\nmysql> show slave status\\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 13.75.108.150\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000001\n          Read_Master_Log_Pos: 1064\n               Relay_Log_File: slave-relay-bin.000002\n                Relay_Log_Pos: 1071\n        Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: test\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 1064\n              Relay_Log_Space: 1278\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 10\n                  Master_UUID: 8c019b28-306a-11ea-80a3-000d3a8507a5\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n```","tags":["MySQL","Binlog"]},{"title":"First Blog","url":"/2019/12/24/First-Blog/"}]
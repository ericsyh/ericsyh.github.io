{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"source/img/avatar.jpg","path":"img/avatar.jpg","modified":1,"renderable":0},{"_id":"source/img/favicon.ico","path":"img/favicon.ico","modified":1,"renderable":0},{"_id":"themes/aircloud/source/css/aircloud.css","path":"css/aircloud.css","modified":1,"renderable":1},{"_id":"themes/aircloud/source/css/aircloud.css.map","path":"css/aircloud.css.map","modified":1,"renderable":1},{"_id":"themes/aircloud/source/css/aircloud.less","path":"css/aircloud.less","modified":1,"renderable":1},{"_id":"themes/aircloud/source/css/gitment.css","path":"css/gitment.css","modified":1,"renderable":1},{"_id":"themes/aircloud/source/js/gitment.js","path":"js/gitment.js","modified":1,"renderable":1},{"_id":"themes/aircloud/source/js/index.js","path":"js/index.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/_posts/Confluence-Server-数据库迁移-from-H2-to-MySQL.md","hash":"159b0717b95dd2cffe950557e21c776c072e2942","modified":1604235700620},{"_id":"source/_posts/First-Blog.md","hash":"efc23abc8be2e05d01dbbdc764a324f686052cda","modified":1592807524000},{"_id":"source/_posts/MySQL-Binlog-Replication.md","hash":"984a2958650382d5074a499e912fafab58d62078","modified":1592810537000},{"_id":"source/_posts/Win10-使用-Kind-部署-Kubernetes.md","hash":"0d33df80dd603f2207144b5e9d387cf9f5f0f030","modified":1604235700620},{"_id":"source/_posts/kubeadm-初探.md","hash":"f8db750390ef15eda58803ea0da8233653f19f0e","modified":1604818559840},{"_id":"source/about/index.md","hash":"061d380a12f6bdfd38f618474e08ec3826f0a43e","modified":1592743171000},{"_id":"source/img/avatar.jpg","hash":"b6a33c4cd762f94e8129b980c5990e17631ba52d","modified":1592621942000},{"_id":"source/img/favicon.ico","hash":"3e39c16139c5a85428eb879306cdcf094bf11848","modified":1592621942000},{"_id":"source/tags/index.md","hash":"22dd3308e0a3db852e008fa8c8d526142e790dcb","modified":1592621942000},{"_id":"themes/aircloud/_config.yml","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/layout/catagory.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/layout/page.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/about.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/about.less","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/diff.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/diff.less","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/page.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/page.less","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/theme.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/source/_less/theme.less","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1592621942000},{"_id":"themes/aircloud/LICENSE","hash":"218b4bf797149a2751a015812a9adefe368185c1","modified":1592621942000},{"_id":"themes/aircloud/readme-en.md","hash":"2903b1e9db12cd72ed6f8c10be14cd7f6afd82cf","modified":1592621942000},{"_id":"themes/aircloud/readme.md","hash":"4be1fc64bd1dc335a986a39594564e89bd7eba43","modified":1592621942000},{"_id":"themes/aircloud/languages/en.yml","hash":"f3dd50ca369974ac7d335fb1cfabf4ebb04a64fa","modified":1592621942000},{"_id":"themes/aircloud/languages/zh.yml","hash":"9ffaff1f5d240c94e44f9ef3b02bbae146af0dd4","modified":1592621942000},{"_id":"themes/aircloud/layout/404.ejs","hash":"8a30233a7b99831bd771121b5f450aaba412e8d5","modified":1592621942000},{"_id":"themes/aircloud/layout/about.ejs","hash":"cec034166ce08d2f8c961178e07b2f0ceac95cf2","modified":1592621942000},{"_id":"themes/aircloud/layout/archive.ejs","hash":"0f8a062f4f2f0648b23bd8c4a21945a6ca60dc1f","modified":1592621942000},{"_id":"themes/aircloud/layout/index.ejs","hash":"09e2407d615be7fe7ac41d11df3b7026e7393080","modified":1592621942000},{"_id":"themes/aircloud/layout/layout.ejs","hash":"7efd113aee90e698e187d0ea1f0b42a1c00d210e","modified":1592621942000},{"_id":"themes/aircloud/layout/post.ejs","hash":"2eb5fc0c2bb801528c3db3b09e6cb4d073e3ad99","modified":1592621942000},{"_id":"themes/aircloud/layout/tags.ejs","hash":"1a174d9213d25d9bf6ef28aabdaea6661cdd88c8","modified":1592621942000},{"_id":"themes/aircloud/layout/_partial/donate.ejs","hash":"81c976a3b7fa5c47ef61181d537220eaf1d55eac","modified":1592621942000},{"_id":"themes/aircloud/layout/_partial/footer.ejs","hash":"33db88f1b03548c5181c04d44387dc68a9c4cdf6","modified":1592621942000},{"_id":"themes/aircloud/layout/_partial/head.ejs","hash":"3f18d5d4951a205bab25b08d6bf85b054c84a21b","modified":1592621942000},{"_id":"themes/aircloud/layout/_partial/nav.ejs","hash":"079fa72aa7a02ee11f6a44a8a9e58eb80fe28190","modified":1592621942000},{"_id":"themes/aircloud/layout/_partial/toc.ejs","hash":"41d11d159011466f0b6272aca9a74df8642b693f","modified":1592621942000},{"_id":"themes/aircloud/source/_less/archive.css","hash":"905efcc06a62d1e8b60df0e12434afa353378d3a","modified":1592621942000},{"_id":"themes/aircloud/source/_less/archive.less","hash":"5538d38614960e69b97a7f80f38b5933851212b8","modified":1592621942000},{"_id":"themes/aircloud/source/_less/common.css","hash":"64914aa6ecd5b948676870e0809e0f220b162e3b","modified":1592621942000},{"_id":"themes/aircloud/source/_less/common.less","hash":"8aef4d8cfdefbcd2e28d4985a4f79a5005ca0b6c","modified":1592621942000},{"_id":"themes/aircloud/source/_less/donate.css","hash":"ae6a676a42321512f0536c5230bb53084aaf2c2f","modified":1592621942000},{"_id":"themes/aircloud/source/_less/donate.less","hash":"d63139f4aa148bf894afa5c1007a4398696a0e4c","modified":1592621942000},{"_id":"themes/aircloud/source/_less/gitment.css","hash":"7d560b64e367129f98424052c660ae82b03a1d02","modified":1592621942000},{"_id":"themes/aircloud/source/_less/gitment.less","hash":"916deb8ecdee798d7a9b43b544e31dfd5bbd6de4","modified":1592621942000},{"_id":"themes/aircloud/source/_less/hightlight.css","hash":"4e5a9ec3e88fbc2ce0faabceff8d3f5099ea1012","modified":1592621942000},{"_id":"themes/aircloud/source/_less/hightlight.less","hash":"4e5a9ec3e88fbc2ce0faabceff8d3f5099ea1012","modified":1592621942000},{"_id":"themes/aircloud/source/_less/index.css","hash":"52fe4d1b93dfb4c9c9d63e24862354b6a0ef47f8","modified":1592621942000},{"_id":"themes/aircloud/source/_less/index.less","hash":"502d689e3568056cc27dd4da7da2499b0be4253e","modified":1592621942000},{"_id":"themes/aircloud/source/_less/layout.css","hash":"40d7cadf42b130ea1b40de1ae73b2b00e27f476f","modified":1592621942000},{"_id":"themes/aircloud/source/_less/layout.less","hash":"194ac7db2eeee7307fcb7470302f8172100181fb","modified":1592621942000},{"_id":"themes/aircloud/source/_less/nav.css","hash":"32e352d71dc2e67d69a26d8b5116a27d8d2a7718","modified":1592621942000},{"_id":"themes/aircloud/source/_less/nav.less","hash":"627e33cafb4ca9c191053b10917fc21c68c6ee8c","modified":1592621942000},{"_id":"themes/aircloud/source/_less/post.css","hash":"4adf531589cb55413264c188b29ae47ab703beb8","modified":1592621942000},{"_id":"themes/aircloud/source/_less/post.less","hash":"bbbd81c03e7581950d82bf971eda49e8bed7bee1","modified":1592621942000},{"_id":"themes/aircloud/source/_less/tag.css","hash":"3250887aaae0bc62bd82082d000ce3de8cc55ab6","modified":1592621942000},{"_id":"themes/aircloud/source/_less/tag.less","hash":"47e1ce2f55e2b62beefd0f69dfe7deb594e7b309","modified":1592621942000},{"_id":"themes/aircloud/source/_less/toc.css","hash":"83b1a219e7fe66d9d6cc34600e5a16311381a883","modified":1592621942000},{"_id":"themes/aircloud/source/_less/toc.less","hash":"c873ce552b22b0aa2c51a386a91516cadf9160ba","modified":1592621942000},{"_id":"themes/aircloud/source/_less/variables.css","hash":"9768d38beea904c4febc704192a49c8f7ae6e06c","modified":1592621942000},{"_id":"themes/aircloud/source/_less/variables.less","hash":"49503f7a6c51edd6f1dbdea5345df6bb903b18a5","modified":1592621942000},{"_id":"themes/aircloud/source/css/aircloud.css","hash":"e6082557a5f0e546169ab1aa0ba29bda4ef5c182","modified":1592621942000},{"_id":"themes/aircloud/source/css/aircloud.css.map","hash":"50db34961d11f6f461e23912609d25141068a6fc","modified":1592621942000},{"_id":"themes/aircloud/source/css/aircloud.less","hash":"45cab2da310dbfcba37ac3db657db77b4adac60d","modified":1592621942000},{"_id":"themes/aircloud/source/css/gitment.css","hash":"926b553be983d6dd90bcb60c5d6d4ee215d268a6","modified":1592621942000},{"_id":"themes/aircloud/source/js/index.js","hash":"1fed4485eedf5309e504aec35596955e5d692c7d","modified":1592621942000},{"_id":"themes/aircloud/source/_less/_partial/footer.css","hash":"e00d722211b4695449d72850340ac0dd701d6ede","modified":1592621942000},{"_id":"themes/aircloud/source/_less/_partial/footer.css.map","hash":"9e8d4df5d08425de5a8b247d0dd8b805c6edc661","modified":1592621942000},{"_id":"themes/aircloud/source/_less/_partial/footer.less","hash":"d1469f97daf750f3e4be18c4d640772780c32a75","modified":1592621942000},{"_id":"themes/aircloud/source/js/gitment.js","hash":"89687f8fffe1125e08323fd6635ca4e53771c05e","modified":1592621942000},{"_id":"public/search.json","hash":"0e03259c3f6aa0076de0039defb7ab59ab9fb3ec","modified":1604818737556},{"_id":"public/about/index.html","hash":"242fe36a342f3916400645ed1c4cced409b9051f","modified":1604818737556},{"_id":"public/tags/index.html","hash":"454b34e742fd92c2cff37dccdad3e8e357a5ef88","modified":1604818737556},{"_id":"public/2020/11/01/Win10-使用-Kind-部署-Kubernetes/index.html","hash":"8a43f9c9bf6b25b2280f0b9f46e439d7a902a93e","modified":1604818737556},{"_id":"public/2020/06/22/Confluence-Server-数据库迁移-from-H2-to-MySQL/index.html","hash":"e82da838196303f5e7c2c9e3ad6dabae349d029b","modified":1604818737556},{"_id":"public/2020/01/06/kubeadm-初探/index.html","hash":"4f78e433adda95d714b53e56418ee79ba8346e43","modified":1604818737556},{"_id":"public/2020/01/05/MySQL-Binlog-Replication/index.html","hash":"623f95725d9160433d3375fa9c11895ea7a2ee89","modified":1604818737556},{"_id":"public/2019/12/24/First-Blog/index.html","hash":"ad8b39e941b6ecef75ceb3a184341fa5fbe1c703","modified":1604818737556},{"_id":"public/index.html","hash":"fe7daa1c993fed6ce4e249b5336d67acdd4b4e4c","modified":1604818737556},{"_id":"public/archive/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2019/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2019/12/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2020/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2020/01/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2020/06/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/archive/2020/11/index.html","hash":"63b9f4f67370fae81596bfed3ee9b9d84a278ee9","modified":1604818737556},{"_id":"public/tags/Confluence/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/Docker/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/MySQL/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/Binlog/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/Kubernetes/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/Kind/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/k8s/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/tags/kubeadm/index.html","hash":"e6dab4d0d43467617746bb13a7a5b2a3c11aaed8","modified":1604818737556},{"_id":"public/img/avatar.jpg","hash":"b6a33c4cd762f94e8129b980c5990e17631ba52d","modified":1604818737556},{"_id":"public/img/favicon.ico","hash":"3e39c16139c5a85428eb879306cdcf094bf11848","modified":1604818737556},{"_id":"public/css/aircloud.css.map","hash":"50db34961d11f6f461e23912609d25141068a6fc","modified":1604818737556},{"_id":"public/css/aircloud.less","hash":"45cab2da310dbfcba37ac3db657db77b4adac60d","modified":1604818737556},{"_id":"public/js/index.js","hash":"1fed4485eedf5309e504aec35596955e5d692c7d","modified":1604818737556},{"_id":"public/css/aircloud.css","hash":"e6082557a5f0e546169ab1aa0ba29bda4ef5c182","modified":1604818737556},{"_id":"public/css/gitment.css","hash":"926b553be983d6dd90bcb60c5d6d4ee215d268a6","modified":1604818737556},{"_id":"public/js/gitment.js","hash":"89687f8fffe1125e08323fd6635ca4e53771c05e","modified":1604818737556}],"Category":[],"Data":[],"Page":[{"layout":"about","title":"About","date":"2019-11-25T10:45:33.000Z","comments":1,"_content":"\nOpen Source fan.","source":"about/index.md","raw":"---\nlayout: \"about\"\ntitle: \"About\"\ndate: 2019-11-25 18:45:33\ncomments: true\n---\n\nOpen Source fan.","updated":"2020-06-21T12:39:31.000Z","path":"about/index.html","_id":"ckh8rn35h0000y9fobey24y3h","content":"<p>Open Source fan.</p>\n","site":{"data":{}},"excerpt":"","more":"<p>Open Source fan.</p>\n"},{"layout":"tags","title":"Tags","_content":"","source":"tags/index.md","raw":"---\nlayout: \"tags\"\ntitle: \"Tags\"\n---","date":"2020-07-19T08:31:32.850Z","updated":"2020-06-20T02:59:02.000Z","path":"tags/index.html","comments":1,"_id":"ckh8rn35m0002y9foal9f7871","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Confluence Server 数据库迁移 from H2 to MySQL","date":"2020-06-22T06:31:11.000Z","_content":"\n## 背景\n之前按照 [Docker安装Confluence](https://www.jianshu.com/p/8e81caca5f2a) 部署了 confluence server。前期为了方便直接使用了 confluence 内嵌的 H2 数据库。后续小伙伴陆陆续续开始使用起来后，为了稳定还是按照官方要求使用外部数据库，并将现有的数据进行迁移。\n\n## 操作步骤\n### 备份 confluence \n1. 使用管理员账号进入 **站点管理** -> **一般配置** -> **备份与还原**，对当前 confluence 进行备份操作\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/18/172c6bd9e19dc5ad?f=png&s=63731\" width=\"648\" height=\"286\" />\n</div>\n\n备份完成后，会在容器 `/var/atlassian/confluence/backups/` 目录下生成相应的备份文件\n\n2. 执行 `docker cp 8172e44b0b61:/var/atlassian/confluence/backups/xmlexport-20200619-051237-3.zip /home/confluence` 命令将站点备份文件从容器中拷贝至主机目录下\n\n### 安装 MySQL\n亲测 MySQL 8.0 不支持，最后选用 MySQL 5.7，提供两种方式进行部署\n\n#### Host 部署 MySQL\n1. 直接 apt 安装 MySQL `sudo apt-get install mysql-server`\n2. 进行 MySQL 的初始化 `sudo mysql_secure_installation`\n3. 进入 MySQL 终端，创建 confluence 库和用户并且授权\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n\n4. 修改 MySQL 配置文件 \n\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n\n重启 MySQL `systemctl restart mysql`\n\n#### Docker 部署 MySQL\n1. 拉取 MySQL 镜像 `docker pull mysql:5.7`\n2. 创建 MySQL 容器 `docker run -p 3306:3306 --name mysql -v /data/mysql:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=<password> -d mysql:5.7`\n3. 进入容器修改配置 `docker exec -it mysql /bin/bash`\n4. 创建 confluence 库和用户并且授权\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n5.修改 MySQL 配置文件\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n6. 重启 MySQL 容器 `docker restart mysql`\n\n### 部署新的 confluence\n1. 将之前的 confluence 容器停止 `docker stop 8172e44b0b61`\n2. 创建新的 confluence 容器 `docker run -d -v /data/conflunece:/var/atlassian/confluence --name confluence -p 8090:8090 --user root:root cptactionhank/atlassian-confluence:latest `\n3. 选择使用非内置数据库\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf145a3b81231?f=png&s=63589\" width=\"603\" height=\"328\" />\n</div>\n\n4. 配置数据库连接\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf1a5de0831bc?f=png&s=71044\" width=\"606\" height=\"400\" />\n</div>\n\n### 数据迁移\n1. 在**加载内容** 页选择 **从备份还原**\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf21da53ad4ec?f=png&s=88344\" width=\"606\" height=\"416\" />\n</div>\n\n2. 将之前站点备份文件导入 `cp /home/confluence/xmlexport-20200619-051237-3.zip /data/conflunece/restore/`\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf24a1e450e1d?f=png&s=40713\" width=\"609\" height=\"220\" />\n</div>\n\n3. 等待数据还原\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf255a3a21f5b?f=png&s=35665\" width=\"607\" height=\"270\" />\n</div>\n\n4. 恢复完成\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf2ceba712728?f=png&s=22243\" width=\"606\" height=\"203\" />\n</div>\n","source":"_posts/Confluence-Server-数据库迁移-from-H2-to-MySQL.md","raw":"---\ntitle: Confluence Server 数据库迁移 from H2 to MySQL\ndate: 2020-06-22 14:31:11\ntags:\n\t- Confluence\n\t- Docker\n---\n\n## 背景\n之前按照 [Docker安装Confluence](https://www.jianshu.com/p/8e81caca5f2a) 部署了 confluence server。前期为了方便直接使用了 confluence 内嵌的 H2 数据库。后续小伙伴陆陆续续开始使用起来后，为了稳定还是按照官方要求使用外部数据库，并将现有的数据进行迁移。\n\n## 操作步骤\n### 备份 confluence \n1. 使用管理员账号进入 **站点管理** -> **一般配置** -> **备份与还原**，对当前 confluence 进行备份操作\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/18/172c6bd9e19dc5ad?f=png&s=63731\" width=\"648\" height=\"286\" />\n</div>\n\n备份完成后，会在容器 `/var/atlassian/confluence/backups/` 目录下生成相应的备份文件\n\n2. 执行 `docker cp 8172e44b0b61:/var/atlassian/confluence/backups/xmlexport-20200619-051237-3.zip /home/confluence` 命令将站点备份文件从容器中拷贝至主机目录下\n\n### 安装 MySQL\n亲测 MySQL 8.0 不支持，最后选用 MySQL 5.7，提供两种方式进行部署\n\n#### Host 部署 MySQL\n1. 直接 apt 安装 MySQL `sudo apt-get install mysql-server`\n2. 进行 MySQL 的初始化 `sudo mysql_secure_installation`\n3. 进入 MySQL 终端，创建 confluence 库和用户并且授权\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n\n4. 修改 MySQL 配置文件 \n\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n\n重启 MySQL `systemctl restart mysql`\n\n#### Docker 部署 MySQL\n1. 拉取 MySQL 镜像 `docker pull mysql:5.7`\n2. 创建 MySQL 容器 `docker run -p 3306:3306 --name mysql -v /data/mysql:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=<password> -d mysql:5.7`\n3. 进入容器修改配置 `docker exec -it mysql /bin/bash`\n4. 创建 confluence 库和用户并且授权\n```\nmysql> CREATE DATABASE confluence CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;\n\nmysql> CREATE USER 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> GRANT ALL PRIVILEGES ON confluence.* TO 'confluence'@'%' IDENTIFIED BY '<password>';\n\nmysql> flush privileges; \n```\n5.修改 MySQL 配置文件\n```\nvim /etc/mysql/mysql.conf.d/mysqld.cnf\n\n[mysqld]\nbind-address = 0.0.0.0 #127.0.0.1\ncharacter-set-server = utf8mb4\ncollation-server = utf8mb4_bin\ndefault-storage-engine = INNODB\nmax_allowed_packet = 256M\ninnodb_log_file_size = 2GB\ntransaction-isolation = READ-COMMITTED\n```\n6. 重启 MySQL 容器 `docker restart mysql`\n\n### 部署新的 confluence\n1. 将之前的 confluence 容器停止 `docker stop 8172e44b0b61`\n2. 创建新的 confluence 容器 `docker run -d -v /data/conflunece:/var/atlassian/confluence --name confluence -p 8090:8090 --user root:root cptactionhank/atlassian-confluence:latest `\n3. 选择使用非内置数据库\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf145a3b81231?f=png&s=63589\" width=\"603\" height=\"328\" />\n</div>\n\n4. 配置数据库连接\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf1a5de0831bc?f=png&s=71044\" width=\"606\" height=\"400\" />\n</div>\n\n### 数据迁移\n1. 在**加载内容** 页选择 **从备份还原**\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf21da53ad4ec?f=png&s=88344\" width=\"606\" height=\"416\" />\n</div>\n\n2. 将之前站点备份文件导入 `cp /home/confluence/xmlexport-20200619-051237-3.zip /data/conflunece/restore/`\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf24a1e450e1d?f=png&s=40713\" width=\"609\" height=\"220\" />\n</div>\n\n3. 等待数据还原\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf255a3a21f5b?f=png&s=35665\" width=\"607\" height=\"270\" />\n</div>\n\n4. 恢复完成\n\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf2ceba712728?f=png&s=22243\" width=\"606\" height=\"203\" />\n</div>\n","slug":"Confluence-Server-数据库迁移-from-H2-to-MySQL","published":1,"updated":"2020-11-01T13:01:40.620Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckh8rn35j0001y9fo39h23pnc","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>之前按照 <a href=\"https://www.jianshu.com/p/8e81caca5f2a\">Docker安装Confluence</a> 部署了 confluence server。前期为了方便直接使用了 confluence 内嵌的 H2 数据库。后续小伙伴陆陆续续开始使用起来后，为了稳定还是按照官方要求使用外部数据库，并将现有的数据进行迁移。</p>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"备份-confluence\"><a href=\"#备份-confluence\" class=\"headerlink\" title=\"备份 confluence\"></a>备份 confluence</h3><ol>\n<li>使用管理员账号进入 <strong>站点管理</strong> -&gt; <strong>一般配置</strong> -&gt; <strong>备份与还原</strong>，对当前 confluence 进行备份操作</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/18/172c6bd9e19dc5ad?f=png&s=63731\" width=\"648\" height=\"286\" />\n</div>\n\n<p>备份完成后，会在容器 <code>/var/atlassian/confluence/backups/</code> 目录下生成相应的备份文件</p>\n<ol start=\"2\">\n<li>执行 <code>docker cp 8172e44b0b61:/var/atlassian/confluence/backups/xmlexport-20200619-051237-3.zip /home/confluence</code> 命令将站点备份文件从容器中拷贝至主机目录下</li>\n</ol>\n<h3 id=\"安装-MySQL\"><a href=\"#安装-MySQL\" class=\"headerlink\" title=\"安装 MySQL\"></a>安装 MySQL</h3><p>亲测 MySQL 8.0 不支持，最后选用 MySQL 5.7，提供两种方式进行部署</p>\n<h4 id=\"Host-部署-MySQL\"><a href=\"#Host-部署-MySQL\" class=\"headerlink\" title=\"Host 部署 MySQL\"></a>Host 部署 MySQL</h4><ol>\n<li><p>直接 apt 安装 MySQL <code>sudo apt-get install mysql-server</code></p>\n</li>\n<li><p>进行 MySQL 的初始化 <code>sudo mysql_secure_installation</code></p>\n</li>\n<li><p>进入 MySQL 终端，创建 confluence 库和用户并且授权</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">DATABASE</span> confluence <span class=\"type\">CHARACTER</span> <span class=\"keyword\">SET</span> utf8mb4 <span class=\"keyword\">COLLATE</span> utf8mb4_bin;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">GRANT</span> <span class=\"keyword\">ALL</span> <span class=\"keyword\">PRIVILEGES</span> <span class=\"keyword\">ON</span> confluence.* <span class=\"keyword\">TO</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; flush <span class=\"keyword\">privileges</span>; </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改 MySQL 配置文件 </p>\n</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">bind-address = 0.0.0.0 <span class=\"comment\">#127.0.0.1</span></span><br><span class=\"line\">character-<span class=\"keyword\">set</span>-<span class=\"keyword\">server</span> = utf8mb4</span><br><span class=\"line\"><span class=\"keyword\">collation</span>-<span class=\"keyword\">server</span> = utf8mb4_bin</span><br><span class=\"line\"><span class=\"keyword\">default</span>-<span class=\"keyword\">storage</span>-<span class=\"keyword\">engine</span> = <span class=\"keyword\">INNODB</span></span><br><span class=\"line\">max_allowed_packet = <span class=\"number\">256</span>M</span><br><span class=\"line\">innodb_log_file_size = <span class=\"number\">2</span>GB</span><br><span class=\"line\"><span class=\"keyword\">transaction</span>-<span class=\"keyword\">isolation</span> = <span class=\"keyword\">READ</span>-COMMITTED</span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL <code>systemctl restart mysql</code></p>\n<h4 id=\"Docker-部署-MySQL\"><a href=\"#Docker-部署-MySQL\" class=\"headerlink\" title=\"Docker 部署 MySQL\"></a>Docker 部署 MySQL</h4><ol>\n<li>拉取 MySQL 镜像 <code>docker pull mysql:5.7</code></li>\n<li>创建 MySQL 容器 <code>docker run -p 3306:3306 --name mysql -v /data/mysql:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=&lt;password&gt; -d mysql:5.7</code></li>\n<li>进入容器修改配置 <code>docker exec -it mysql /bin/bash</code></li>\n<li>创建 confluence 库和用户并且授权<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">DATABASE</span> confluence <span class=\"type\">CHARACTER</span> <span class=\"keyword\">SET</span> utf8mb4 <span class=\"keyword\">COLLATE</span> utf8mb4_bin;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">GRANT</span> <span class=\"keyword\">ALL</span> <span class=\"keyword\">PRIVILEGES</span> <span class=\"keyword\">ON</span> confluence.* <span class=\"keyword\">TO</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; flush <span class=\"keyword\">privileges</span>; </span><br></pre></td></tr></table></figure></li>\n<li>修改 MySQL 配置文件<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">bind-address = 0.0.0.0 <span class=\"comment\">#127.0.0.1</span></span><br><span class=\"line\">character-<span class=\"keyword\">set</span>-<span class=\"keyword\">server</span> = utf8mb4</span><br><span class=\"line\"><span class=\"keyword\">collation</span>-<span class=\"keyword\">server</span> = utf8mb4_bin</span><br><span class=\"line\"><span class=\"keyword\">default</span>-<span class=\"keyword\">storage</span>-<span class=\"keyword\">engine</span> = <span class=\"keyword\">INNODB</span></span><br><span class=\"line\">max_allowed_packet = <span class=\"number\">256</span>M</span><br><span class=\"line\">innodb_log_file_size = <span class=\"number\">2</span>GB</span><br><span class=\"line\"><span class=\"keyword\">transaction</span>-<span class=\"keyword\">isolation</span> = <span class=\"keyword\">READ</span>-COMMITTED</span><br></pre></td></tr></table></figure></li>\n<li>重启 MySQL 容器 <code>docker restart mysql</code></li>\n</ol>\n<h3 id=\"部署新的-confluence\"><a href=\"#部署新的-confluence\" class=\"headerlink\" title=\"部署新的 confluence\"></a>部署新的 confluence</h3><ol>\n<li>将之前的 confluence 容器停止 <code>docker stop 8172e44b0b61</code></li>\n<li>创建新的 confluence 容器 <code>docker run -d -v /data/conflunece:/var/atlassian/confluence --name confluence -p 8090:8090 --user root:root cptactionhank/atlassian-confluence:latest</code></li>\n<li>选择使用非内置数据库</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf145a3b81231?f=png&s=63589\" width=\"603\" height=\"328\" />\n</div>\n\n<ol start=\"4\">\n<li>配置数据库连接</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf1a5de0831bc?f=png&s=71044\" width=\"606\" height=\"400\" />\n</div>\n\n<h3 id=\"数据迁移\"><a href=\"#数据迁移\" class=\"headerlink\" title=\"数据迁移\"></a>数据迁移</h3><ol>\n<li>在<strong>加载内容</strong> 页选择 <strong>从备份还原</strong></li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf21da53ad4ec?f=png&s=88344\" width=\"606\" height=\"416\" />\n</div>\n\n<ol start=\"2\">\n<li>将之前站点备份文件导入 <code>cp /home/confluence/xmlexport-20200619-051237-3.zip /data/conflunece/restore/</code></li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf24a1e450e1d?f=png&s=40713\" width=\"609\" height=\"220\" />\n</div>\n\n<ol start=\"3\">\n<li>等待数据还原</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf255a3a21f5b?f=png&s=35665\" width=\"607\" height=\"270\" />\n</div>\n\n<ol start=\"4\">\n<li>恢复完成</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf2ceba712728?f=png&s=22243\" width=\"606\" height=\"203\" />\n</div>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>之前按照 <a href=\"https://www.jianshu.com/p/8e81caca5f2a\">Docker安装Confluence</a> 部署了 confluence server。前期为了方便直接使用了 confluence 内嵌的 H2 数据库。后续小伙伴陆陆续续开始使用起来后，为了稳定还是按照官方要求使用外部数据库，并将现有的数据进行迁移。</p>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"备份-confluence\"><a href=\"#备份-confluence\" class=\"headerlink\" title=\"备份 confluence\"></a>备份 confluence</h3><ol>\n<li>使用管理员账号进入 <strong>站点管理</strong> -&gt; <strong>一般配置</strong> -&gt; <strong>备份与还原</strong>，对当前 confluence 进行备份操作</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/18/172c6bd9e19dc5ad?f=png&s=63731\" width=\"648\" height=\"286\" />\n</div>\n\n<p>备份完成后，会在容器 <code>/var/atlassian/confluence/backups/</code> 目录下生成相应的备份文件</p>\n<ol start=\"2\">\n<li>执行 <code>docker cp 8172e44b0b61:/var/atlassian/confluence/backups/xmlexport-20200619-051237-3.zip /home/confluence</code> 命令将站点备份文件从容器中拷贝至主机目录下</li>\n</ol>\n<h3 id=\"安装-MySQL\"><a href=\"#安装-MySQL\" class=\"headerlink\" title=\"安装 MySQL\"></a>安装 MySQL</h3><p>亲测 MySQL 8.0 不支持，最后选用 MySQL 5.7，提供两种方式进行部署</p>\n<h4 id=\"Host-部署-MySQL\"><a href=\"#Host-部署-MySQL\" class=\"headerlink\" title=\"Host 部署 MySQL\"></a>Host 部署 MySQL</h4><ol>\n<li><p>直接 apt 安装 MySQL <code>sudo apt-get install mysql-server</code></p>\n</li>\n<li><p>进行 MySQL 的初始化 <code>sudo mysql_secure_installation</code></p>\n</li>\n<li><p>进入 MySQL 终端，创建 confluence 库和用户并且授权</p>\n<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">DATABASE</span> confluence <span class=\"type\">CHARACTER</span> <span class=\"keyword\">SET</span> utf8mb4 <span class=\"keyword\">COLLATE</span> utf8mb4_bin;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">GRANT</span> <span class=\"keyword\">ALL</span> <span class=\"keyword\">PRIVILEGES</span> <span class=\"keyword\">ON</span> confluence.* <span class=\"keyword\">TO</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; flush <span class=\"keyword\">privileges</span>; </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改 MySQL 配置文件 </p>\n</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">bind-address = 0.0.0.0 <span class=\"comment\">#127.0.0.1</span></span><br><span class=\"line\">character-<span class=\"keyword\">set</span>-<span class=\"keyword\">server</span> = utf8mb4</span><br><span class=\"line\"><span class=\"keyword\">collation</span>-<span class=\"keyword\">server</span> = utf8mb4_bin</span><br><span class=\"line\"><span class=\"keyword\">default</span>-<span class=\"keyword\">storage</span>-<span class=\"keyword\">engine</span> = <span class=\"keyword\">INNODB</span></span><br><span class=\"line\">max_allowed_packet = <span class=\"number\">256</span>M</span><br><span class=\"line\">innodb_log_file_size = <span class=\"number\">2</span>GB</span><br><span class=\"line\"><span class=\"keyword\">transaction</span>-<span class=\"keyword\">isolation</span> = <span class=\"keyword\">READ</span>-COMMITTED</span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL <code>systemctl restart mysql</code></p>\n<h4 id=\"Docker-部署-MySQL\"><a href=\"#Docker-部署-MySQL\" class=\"headerlink\" title=\"Docker 部署 MySQL\"></a>Docker 部署 MySQL</h4><ol>\n<li>拉取 MySQL 镜像 <code>docker pull mysql:5.7</code></li>\n<li>创建 MySQL 容器 <code>docker run -p 3306:3306 --name mysql -v /data/mysql:/var/lib/mysql/ -e MYSQL_ROOT_PASSWORD=&lt;password&gt; -d mysql:5.7</code></li>\n<li>进入容器修改配置 <code>docker exec -it mysql /bin/bash</code></li>\n<li>创建 confluence 库和用户并且授权<figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">DATABASE</span> confluence <span class=\"type\">CHARACTER</span> <span class=\"keyword\">SET</span> utf8mb4 <span class=\"keyword\">COLLATE</span> utf8mb4_bin;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">CREATE</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; <span class=\"keyword\">GRANT</span> <span class=\"keyword\">ALL</span> <span class=\"keyword\">PRIVILEGES</span> <span class=\"keyword\">ON</span> confluence.* <span class=\"keyword\">TO</span> <span class=\"string\">&#x27;confluence&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;&lt;password&gt;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; flush <span class=\"keyword\">privileges</span>; </span><br></pre></td></tr></table></figure></li>\n<li>修改 MySQL 配置文件<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/mysql/mysql.conf.d/mysqld.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">bind-address = 0.0.0.0 <span class=\"comment\">#127.0.0.1</span></span><br><span class=\"line\">character-<span class=\"keyword\">set</span>-<span class=\"keyword\">server</span> = utf8mb4</span><br><span class=\"line\"><span class=\"keyword\">collation</span>-<span class=\"keyword\">server</span> = utf8mb4_bin</span><br><span class=\"line\"><span class=\"keyword\">default</span>-<span class=\"keyword\">storage</span>-<span class=\"keyword\">engine</span> = <span class=\"keyword\">INNODB</span></span><br><span class=\"line\">max_allowed_packet = <span class=\"number\">256</span>M</span><br><span class=\"line\">innodb_log_file_size = <span class=\"number\">2</span>GB</span><br><span class=\"line\"><span class=\"keyword\">transaction</span>-<span class=\"keyword\">isolation</span> = <span class=\"keyword\">READ</span>-COMMITTED</span><br></pre></td></tr></table></figure></li>\n<li>重启 MySQL 容器 <code>docker restart mysql</code></li>\n</ol>\n<h3 id=\"部署新的-confluence\"><a href=\"#部署新的-confluence\" class=\"headerlink\" title=\"部署新的 confluence\"></a>部署新的 confluence</h3><ol>\n<li>将之前的 confluence 容器停止 <code>docker stop 8172e44b0b61</code></li>\n<li>创建新的 confluence 容器 <code>docker run -d -v /data/conflunece:/var/atlassian/confluence --name confluence -p 8090:8090 --user root:root cptactionhank/atlassian-confluence:latest</code></li>\n<li>选择使用非内置数据库</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf145a3b81231?f=png&s=63589\" width=\"603\" height=\"328\" />\n</div>\n\n<ol start=\"4\">\n<li>配置数据库连接</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf1a5de0831bc?f=png&s=71044\" width=\"606\" height=\"400\" />\n</div>\n\n<h3 id=\"数据迁移\"><a href=\"#数据迁移\" class=\"headerlink\" title=\"数据迁移\"></a>数据迁移</h3><ol>\n<li>在<strong>加载内容</strong> 页选择 <strong>从备份还原</strong></li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf21da53ad4ec?f=png&s=88344\" width=\"606\" height=\"416\" />\n</div>\n\n<ol start=\"2\">\n<li>将之前站点备份文件导入 <code>cp /home/confluence/xmlexport-20200619-051237-3.zip /data/conflunece/restore/</code></li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf24a1e450e1d?f=png&s=40713\" width=\"609\" height=\"220\" />\n</div>\n\n<ol start=\"3\">\n<li>等待数据还原</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf255a3a21f5b?f=png&s=35665\" width=\"607\" height=\"270\" />\n</div>\n\n<ol start=\"4\">\n<li>恢复完成</li>\n</ol>\n<div align=\"center\">    \n    <img src=\"https://user-gold-cdn.xitu.io/2020/6/20/172cf2ceba712728?f=png&s=22243\" width=\"606\" height=\"203\" />\n</div>\n"},{"title":"First Blog","date":"2019-12-24T12:57:45.000Z","_content":"","source":"_posts/First-Blog.md","raw":"---\ntitle: First Blog\ndate: 2019-12-24 20:57:45\ntags:\n---\n","slug":"First-Blog","published":1,"updated":"2020-06-22T06:32:04.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckh8rn35n0003y9foff4w9qdo","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"MySQL Binlog Replication","date":"2020-01-05T13:32:41.000Z","_content":"\nMySQL 开启 binlog 配置主从同步步骤整理。\n\n\n## 示例服务器准备\n\nAzure VM 上创建两台 centos 7.5 服务器分别作为 MySQL master 和 My SQL slave：\n\n* master: 13.75.108.150\n* slave: 13.75.109.41\n\n## 操作步骤\n### 安装 MySQL \n#### 添加 MySQL 5.7仓库\n\n```\nsudo rpm -ivh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm\n```\n\n#### 安装 MySQL 5.7\n\n```\nsudo yum -y install mysql-community-server\n```\n\n#### MySQL 服务配置\n\n##### 启动 MySQL 服务\n\n```\nsudo systemctl start mysqld\n```\n\n##### 设置开启自启\n\n```\nsudo systemctl enable mysqld\n```\n\n#### 安全设置\n\n##### 获取 MySQL 临时密码\n\n```\ncat /var/log/mysqld.log | grep -i 'temporary password'\n```\n\n##### 配置安全设置\n\n```\nmysql_secure_installation\n```\n\n### 配置 binlog 主从同步\n\n#### master 服务器配置\n\n##### 创建同步用户\n\n```\nmysql> CREATE USER 'slave'@'%' IDENTIFIED BY '{YOUR PASSWORD}';\n\nmysql> GRANT ALL PRIVILEGES ON *.* TO slave@\"%\" IDENTIFIED BY \"{YOUR PASSWORD}\";\n```\n\n##### 开启 binlog\n\n修改 `/etc/my.cnf` 文件，添加内容如下：\n\n```\nlog-bin=mysql-bin\nserver-id=10\n```\n\n重启 MySQL 服务：\n\n```\nsystemctl restart mysqld.service\n```\n\n##### 获取初始同步位置\n\n```\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |      154 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n```\n\n#### slave 服务器配置\n\n##### 修改 MySQL 配置\n\n修改 `/etc/my.cnf` 文件，添加内容如下：\n\n```\nserver-id=12\nreplicate-do-db=test\nskip-slave-start=true\n```\n\n重启 MySQL 服务：\n\n```\nsystemctl restart mysqld.service\n```\n\n##### 配置主从同步\n\n停止 slave 服务进程：\n\n```\nmysql> stop slave;\n```\n\n配置同步上游信息：\n\n```\nmysql> change master to \nmaster_host='13.75.108.150',\nmaster_user='slave',\nmaster_password='{YOUR PASSWORD}',\nmaster_log_file='mysql-bin.000001', \nmaster_log_pos=313;\n```\n\n开启 slave 服务进程：\n\n```\nmysql> start slave;\n```\n\n查看 slave 同步状态：\n\n```\nmysql> show slave status\\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 13.75.108.150\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000001\n          Read_Master_Log_Pos: 1064\n               Relay_Log_File: slave-relay-bin.000002\n                Relay_Log_Pos: 1071\n        Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: test\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 1064\n              Relay_Log_Space: 1278\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 10\n                  Master_UUID: 8c019b28-306a-11ea-80a3-000d3a8507a5\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n```","source":"_posts/MySQL-Binlog-Replication.md","raw":"---\ntitle: MySQL Binlog Replication\ndate: 2020-01-05 21:32:41\ntags: \n\t- MySQL \n\t- Binlog\n---\n\nMySQL 开启 binlog 配置主从同步步骤整理。\n\n\n## 示例服务器准备\n\nAzure VM 上创建两台 centos 7.5 服务器分别作为 MySQL master 和 My SQL slave：\n\n* master: 13.75.108.150\n* slave: 13.75.109.41\n\n## 操作步骤\n### 安装 MySQL \n#### 添加 MySQL 5.7仓库\n\n```\nsudo rpm -ivh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm\n```\n\n#### 安装 MySQL 5.7\n\n```\nsudo yum -y install mysql-community-server\n```\n\n#### MySQL 服务配置\n\n##### 启动 MySQL 服务\n\n```\nsudo systemctl start mysqld\n```\n\n##### 设置开启自启\n\n```\nsudo systemctl enable mysqld\n```\n\n#### 安全设置\n\n##### 获取 MySQL 临时密码\n\n```\ncat /var/log/mysqld.log | grep -i 'temporary password'\n```\n\n##### 配置安全设置\n\n```\nmysql_secure_installation\n```\n\n### 配置 binlog 主从同步\n\n#### master 服务器配置\n\n##### 创建同步用户\n\n```\nmysql> CREATE USER 'slave'@'%' IDENTIFIED BY '{YOUR PASSWORD}';\n\nmysql> GRANT ALL PRIVILEGES ON *.* TO slave@\"%\" IDENTIFIED BY \"{YOUR PASSWORD}\";\n```\n\n##### 开启 binlog\n\n修改 `/etc/my.cnf` 文件，添加内容如下：\n\n```\nlog-bin=mysql-bin\nserver-id=10\n```\n\n重启 MySQL 服务：\n\n```\nsystemctl restart mysqld.service\n```\n\n##### 获取初始同步位置\n\n```\nmysql> show master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |      154 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n```\n\n#### slave 服务器配置\n\n##### 修改 MySQL 配置\n\n修改 `/etc/my.cnf` 文件，添加内容如下：\n\n```\nserver-id=12\nreplicate-do-db=test\nskip-slave-start=true\n```\n\n重启 MySQL 服务：\n\n```\nsystemctl restart mysqld.service\n```\n\n##### 配置主从同步\n\n停止 slave 服务进程：\n\n```\nmysql> stop slave;\n```\n\n配置同步上游信息：\n\n```\nmysql> change master to \nmaster_host='13.75.108.150',\nmaster_user='slave',\nmaster_password='{YOUR PASSWORD}',\nmaster_log_file='mysql-bin.000001', \nmaster_log_pos=313;\n```\n\n开启 slave 服务进程：\n\n```\nmysql> start slave;\n```\n\n查看 slave 同步状态：\n\n```\nmysql> show slave status\\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 13.75.108.150\n                  Master_User: slave\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000001\n          Read_Master_Log_Pos: 1064\n               Relay_Log_File: slave-relay-bin.000002\n                Relay_Log_Pos: 1071\n        Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: test\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 1064\n              Relay_Log_Space: 1278\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 10\n                  Master_UUID: 8c019b28-306a-11ea-80a3-000d3a8507a5\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: 0\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n```","slug":"MySQL-Binlog-Replication","published":1,"updated":"2020-06-22T07:22:17.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckh8rn35r0005y9fo87pn2omp","content":"<p>MySQL 开启 binlog 配置主从同步步骤整理。</p>\n<h2 id=\"示例服务器准备\"><a href=\"#示例服务器准备\" class=\"headerlink\" title=\"示例服务器准备\"></a>示例服务器准备</h2><p>Azure VM 上创建两台 centos 7.5 服务器分别作为 MySQL master 和 My SQL slave：</p>\n<ul>\n<li>master: 13.75.108.150</li>\n<li>slave: 13.75.109.41</li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"安装-MySQL\"><a href=\"#安装-MySQL\" class=\"headerlink\" title=\"安装 MySQL\"></a>安装 MySQL</h3><h4 id=\"添加-MySQL-5-7仓库\"><a href=\"#添加-MySQL-5-7仓库\" class=\"headerlink\" title=\"添加 MySQL 5.7仓库\"></a>添加 MySQL 5.7仓库</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo rpm -ivh https:<span class=\"regexp\">//</span>dev.mysql.com<span class=\"regexp\">/get/my</span>sql57-community-release-el7-<span class=\"number\">11</span>.noarch.rpm</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装-MySQL-5-7\"><a href=\"#安装-MySQL-5-7\" class=\"headerlink\" title=\"安装 MySQL 5.7\"></a>安装 MySQL 5.7</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum -y <span class=\"keyword\">install</span> mysql-community-<span class=\"keyword\">server</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"MySQL-服务配置\"><a href=\"#MySQL-服务配置\" class=\"headerlink\" title=\"MySQL 服务配置\"></a>MySQL 服务配置</h4><h5 id=\"启动-MySQL-服务\"><a href=\"#启动-MySQL-服务\" class=\"headerlink\" title=\"启动 MySQL 服务\"></a>启动 MySQL 服务</h5><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"literal\">start</span> mysqld</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置开启自启\"><a href=\"#设置开启自启\" class=\"headerlink\" title=\"设置开启自启\"></a>设置开启自启</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"builtin-name\">enable</span> mysqld</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安全设置\"><a href=\"#安全设置\" class=\"headerlink\" title=\"安全设置\"></a>安全设置</h4><h5 id=\"获取-MySQL-临时密码\"><a href=\"#获取-MySQL-临时密码\" class=\"headerlink\" title=\"获取 MySQL 临时密码\"></a>获取 MySQL 临时密码</h5><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/mysqld.<span class=\"built_in\">log</span> | <span class=\"keyword\">grep</span> -i <span class=\"string\">&#x27;temporary password&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置安全设置\"><a href=\"#配置安全设置\" class=\"headerlink\" title=\"配置安全设置\"></a>配置安全设置</h5><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">mysql_secure_installation</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置-binlog-主从同步\"><a href=\"#配置-binlog-主从同步\" class=\"headerlink\" title=\"配置 binlog 主从同步\"></a>配置 binlog 主从同步</h3><h4 id=\"master-服务器配置\"><a href=\"#master-服务器配置\" class=\"headerlink\" title=\"master 服务器配置\"></a>master 服务器配置</h4><h5 id=\"创建同步用户\"><a href=\"#创建同步用户\" class=\"headerlink\" title=\"创建同步用户\"></a>创建同步用户</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; CREATE<span class=\"built_in\"> USER </span><span class=\"string\">&#x27;slave&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED BY <span class=\"string\">&#x27;&#123;YOUR PASSWORD&#125;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; GRANT ALL PRIVILEGES ON *.* <span class=\"keyword\">TO</span> slave@<span class=\"string\">&quot;%&quot;</span> IDENTIFIED BY <span class=\"string\">&quot;&#123;YOUR PASSWORD&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"开启-binlog\"><a href=\"#开启-binlog\" class=\"headerlink\" title=\"开启 binlog\"></a>开启 binlog</h5><p>修改 <code>/etc/my.cnf</code> 文件，添加内容如下：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">log-bin</span>=mysql-bin</span><br><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">10</span></span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL 服务：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">restart</span> <span class=\"selector-tag\">mysqld</span><span class=\"selector-class\">.service</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"获取初始同步位置\"><a href=\"#获取初始同步位置\" class=\"headerlink\" title=\"获取初始同步位置\"></a>获取初始同步位置</h5><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show master status;</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br><span class=\"line\">| File             | Position | Binlog<span class=\"emphasis\">_Do_</span>DB | Binlog<span class=\"emphasis\">_Ignore_</span>DB | Executed<span class=\"emphasis\">_Gtid_</span>Set |</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br><span class=\"line\">| mysql-bin.000001 |      154 |              |                  |                   |</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"slave-服务器配置\"><a href=\"#slave-服务器配置\" class=\"headerlink\" title=\"slave 服务器配置\"></a>slave 服务器配置</h4><h5 id=\"修改-MySQL-配置\"><a href=\"#修改-MySQL-配置\" class=\"headerlink\" title=\"修改 MySQL 配置\"></a>修改 MySQL 配置</h5><p>修改 <code>/etc/my.cnf</code> 文件，添加内容如下：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">12</span></span><br><span class=\"line\"><span class=\"attr\">replicate-do-db</span>=test</span><br><span class=\"line\"><span class=\"attr\">skip-slave-start</span>=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL 服务：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">restart</span> <span class=\"selector-tag\">mysqld</span><span class=\"selector-class\">.service</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置主从同步\"><a href=\"#配置主从同步\" class=\"headerlink\" title=\"配置主从同步\"></a>配置主从同步</h5><p>停止 slave 服务进程：</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"literal\">stop</span> <span class=\"literal\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<p>配置同步上游信息：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; change master <span class=\"keyword\">to</span> </span><br><span class=\"line\"><span class=\"attribute\">master_host</span>=<span class=\"string\">&#x27;13.75.108.150&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_user</span>=<span class=\"string\">&#x27;slave&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_password</span>=<span class=\"string\">&#x27;&#123;YOUR PASSWORD&#125;&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_log_file</span>=<span class=\"string\">&#x27;mysql-bin.000001&#x27;</span>, </span><br><span class=\"line\"><span class=\"attribute\">master_log_pos</span>=313;</span><br></pre></td></tr></table></figure>\n\n<p>开启 slave 服务进程：</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"literal\">start</span> <span class=\"literal\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<p>查看 slave 同步状态：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mysql&gt;</span> <span class=\"string\">show</span> <span class=\"string\">slave</span> <span class=\"string\">status\\G;</span></span><br><span class=\"line\"><span class=\"string\">***************************</span> <span class=\"number\">1</span><span class=\"string\">.</span> <span class=\"string\">row</span> <span class=\"string\">***************************</span></span><br><span class=\"line\">               <span class=\"attr\">Slave_IO_State:</span> <span class=\"string\">Waiting</span> <span class=\"string\">for</span> <span class=\"string\">master</span> <span class=\"string\">to</span> <span class=\"string\">send</span> <span class=\"string\">event</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Host:</span> <span class=\"number\">13.75</span><span class=\"number\">.108</span><span class=\"number\">.150</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_User:</span> <span class=\"string\">slave</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">                <span class=\"attr\">Connect_Retry:</span> <span class=\"number\">60</span></span><br><span class=\"line\">              <span class=\"attr\">Master_Log_File:</span> <span class=\"string\">mysql-bin.000001</span></span><br><span class=\"line\">          <span class=\"attr\">Read_Master_Log_Pos:</span> <span class=\"number\">1064</span></span><br><span class=\"line\">               <span class=\"attr\">Relay_Log_File:</span> <span class=\"string\">slave-relay-bin.000002</span></span><br><span class=\"line\">                <span class=\"attr\">Relay_Log_Pos:</span> <span class=\"number\">1071</span></span><br><span class=\"line\">        <span class=\"attr\">Relay_Master_Log_File:</span> <span class=\"string\">mysql-bin.000001</span></span><br><span class=\"line\">             <span class=\"attr\">Slave_IO_Running:</span> <span class=\"literal\">Yes</span></span><br><span class=\"line\">            <span class=\"attr\">Slave_SQL_Running:</span> <span class=\"literal\">Yes</span></span><br><span class=\"line\">              <span class=\"attr\">Replicate_Do_DB:</span> <span class=\"string\">test</span></span><br><span class=\"line\">          <span class=\"attr\">Replicate_Ignore_DB:</span></span><br><span class=\"line\">           <span class=\"attr\">Replicate_Do_Table:</span></span><br><span class=\"line\">       <span class=\"attr\">Replicate_Ignore_Table:</span></span><br><span class=\"line\">      <span class=\"attr\">Replicate_Wild_Do_Table:</span></span><br><span class=\"line\">  <span class=\"attr\">Replicate_Wild_Ignore_Table:</span></span><br><span class=\"line\">                   <span class=\"attr\">Last_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">                   <span class=\"attr\">Last_Error:</span></span><br><span class=\"line\">                 <span class=\"attr\">Skip_Counter:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">Exec_Master_Log_Pos:</span> <span class=\"number\">1064</span></span><br><span class=\"line\">              <span class=\"attr\">Relay_Log_Space:</span> <span class=\"number\">1278</span></span><br><span class=\"line\">              <span class=\"attr\">Until_Condition:</span> <span class=\"string\">None</span></span><br><span class=\"line\">               <span class=\"attr\">Until_Log_File:</span></span><br><span class=\"line\">                <span class=\"attr\">Until_Log_Pos:</span> <span class=\"number\">0</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_Allowed:</span> <span class=\"literal\">No</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_CA_File:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_CA_Path:</span></span><br><span class=\"line\">              <span class=\"attr\">Master_SSL_Cert:</span></span><br><span class=\"line\">            <span class=\"attr\">Master_SSL_Cipher:</span></span><br><span class=\"line\">               <span class=\"attr\">Master_SSL_Key:</span></span><br><span class=\"line\">        <span class=\"attr\">Seconds_Behind_Master:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">Master_SSL_Verify_Server_Cert:</span> <span class=\"literal\">No</span></span><br><span class=\"line\">                <span class=\"attr\">Last_IO_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">                <span class=\"attr\">Last_IO_Error:</span></span><br><span class=\"line\">               <span class=\"attr\">Last_SQL_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">               <span class=\"attr\">Last_SQL_Error:</span></span><br><span class=\"line\">  <span class=\"attr\">Replicate_Ignore_Server_Ids:</span></span><br><span class=\"line\">             <span class=\"attr\">Master_Server_Id:</span> <span class=\"number\">10</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_UUID:</span> <span class=\"string\">8c019b28-306a-11ea-80a3-000d3a8507a5</span></span><br><span class=\"line\">             <span class=\"attr\">Master_Info_File:</span> <span class=\"string\">/var/lib/mysql/master.info</span></span><br><span class=\"line\">                    <span class=\"attr\">SQL_Delay:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">SQL_Remaining_Delay:</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\">      <span class=\"attr\">Slave_SQL_Running_State:</span> <span class=\"string\">Slave</span> <span class=\"string\">has</span> <span class=\"string\">read</span> <span class=\"string\">all</span> <span class=\"string\">relay</span> <span class=\"string\">log;</span> <span class=\"string\">waiting</span> <span class=\"string\">for</span> <span class=\"string\">more</span> <span class=\"string\">updates</span></span><br><span class=\"line\">           <span class=\"attr\">Master_Retry_Count:</span> <span class=\"number\">86400</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Bind:</span></span><br><span class=\"line\">      <span class=\"attr\">Last_IO_Error_Timestamp:</span></span><br><span class=\"line\">     <span class=\"attr\">Last_SQL_Error_Timestamp:</span></span><br><span class=\"line\">               <span class=\"attr\">Master_SSL_Crl:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_Crlpath:</span></span><br><span class=\"line\">           <span class=\"attr\">Retrieved_Gtid_Set:</span></span><br><span class=\"line\">            <span class=\"attr\">Executed_Gtid_Set:</span></span><br><span class=\"line\">                <span class=\"attr\">Auto_Position:</span> <span class=\"number\">0</span></span><br><span class=\"line\">         <span class=\"attr\">Replicate_Rewrite_DB:</span></span><br><span class=\"line\">                 <span class=\"attr\">Channel_Name:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_TLS_Version:</span></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"","more":"<p>MySQL 开启 binlog 配置主从同步步骤整理。</p>\n<h2 id=\"示例服务器准备\"><a href=\"#示例服务器准备\" class=\"headerlink\" title=\"示例服务器准备\"></a>示例服务器准备</h2><p>Azure VM 上创建两台 centos 7.5 服务器分别作为 MySQL master 和 My SQL slave：</p>\n<ul>\n<li>master: 13.75.108.150</li>\n<li>slave: 13.75.109.41</li>\n</ul>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"安装-MySQL\"><a href=\"#安装-MySQL\" class=\"headerlink\" title=\"安装 MySQL\"></a>安装 MySQL</h3><h4 id=\"添加-MySQL-5-7仓库\"><a href=\"#添加-MySQL-5-7仓库\" class=\"headerlink\" title=\"添加 MySQL 5.7仓库\"></a>添加 MySQL 5.7仓库</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo rpm -ivh https:<span class=\"regexp\">//</span>dev.mysql.com<span class=\"regexp\">/get/my</span>sql57-community-release-el7-<span class=\"number\">11</span>.noarch.rpm</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装-MySQL-5-7\"><a href=\"#安装-MySQL-5-7\" class=\"headerlink\" title=\"安装 MySQL 5.7\"></a>安装 MySQL 5.7</h4><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum -y <span class=\"keyword\">install</span> mysql-community-<span class=\"keyword\">server</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"MySQL-服务配置\"><a href=\"#MySQL-服务配置\" class=\"headerlink\" title=\"MySQL 服务配置\"></a>MySQL 服务配置</h4><h5 id=\"启动-MySQL-服务\"><a href=\"#启动-MySQL-服务\" class=\"headerlink\" title=\"启动 MySQL 服务\"></a>启动 MySQL 服务</h5><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"literal\">start</span> mysqld</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置开启自启\"><a href=\"#设置开启自启\" class=\"headerlink\" title=\"设置开启自启\"></a>设置开启自启</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"builtin-name\">enable</span> mysqld</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安全设置\"><a href=\"#安全设置\" class=\"headerlink\" title=\"安全设置\"></a>安全设置</h4><h5 id=\"获取-MySQL-临时密码\"><a href=\"#获取-MySQL-临时密码\" class=\"headerlink\" title=\"获取 MySQL 临时密码\"></a>获取 MySQL 临时密码</h5><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">cat</span> /var/<span class=\"built_in\">log</span>/mysqld.<span class=\"built_in\">log</span> | <span class=\"keyword\">grep</span> -i <span class=\"string\">&#x27;temporary password&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置安全设置\"><a href=\"#配置安全设置\" class=\"headerlink\" title=\"配置安全设置\"></a>配置安全设置</h5><figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">mysql_secure_installation</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置-binlog-主从同步\"><a href=\"#配置-binlog-主从同步\" class=\"headerlink\" title=\"配置 binlog 主从同步\"></a>配置 binlog 主从同步</h3><h4 id=\"master-服务器配置\"><a href=\"#master-服务器配置\" class=\"headerlink\" title=\"master 服务器配置\"></a>master 服务器配置</h4><h5 id=\"创建同步用户\"><a href=\"#创建同步用户\" class=\"headerlink\" title=\"创建同步用户\"></a>创建同步用户</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; CREATE<span class=\"built_in\"> USER </span><span class=\"string\">&#x27;slave&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED BY <span class=\"string\">&#x27;&#123;YOUR PASSWORD&#125;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; GRANT ALL PRIVILEGES ON *.* <span class=\"keyword\">TO</span> slave@<span class=\"string\">&quot;%&quot;</span> IDENTIFIED BY <span class=\"string\">&quot;&#123;YOUR PASSWORD&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"开启-binlog\"><a href=\"#开启-binlog\" class=\"headerlink\" title=\"开启 binlog\"></a>开启 binlog</h5><p>修改 <code>/etc/my.cnf</code> 文件，添加内容如下：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">log-bin</span>=mysql-bin</span><br><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">10</span></span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL 服务：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">restart</span> <span class=\"selector-tag\">mysqld</span><span class=\"selector-class\">.service</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"获取初始同步位置\"><a href=\"#获取初始同步位置\" class=\"headerlink\" title=\"获取初始同步位置\"></a>获取初始同步位置</h5><figure class=\"highlight asciidoc\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show master status;</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br><span class=\"line\">| File             | Position | Binlog<span class=\"emphasis\">_Do_</span>DB | Binlog<span class=\"emphasis\">_Ignore_</span>DB | Executed<span class=\"emphasis\">_Gtid_</span>Set |</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br><span class=\"line\">| mysql-bin.000001 |      154 |              |                  |                   |</span><br><span class=\"line\"><span class=\"code\">+------------------+</span>----------<span class=\"code\">+--------------+</span>------------------<span class=\"code\">+-------------------+</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"slave-服务器配置\"><a href=\"#slave-服务器配置\" class=\"headerlink\" title=\"slave 服务器配置\"></a>slave 服务器配置</h4><h5 id=\"修改-MySQL-配置\"><a href=\"#修改-MySQL-配置\" class=\"headerlink\" title=\"修改 MySQL 配置\"></a>修改 MySQL 配置</h5><p>修改 <code>/etc/my.cnf</code> 文件，添加内容如下：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server-id</span>=<span class=\"number\">12</span></span><br><span class=\"line\"><span class=\"attr\">replicate-do-db</span>=test</span><br><span class=\"line\"><span class=\"attr\">skip-slave-start</span>=<span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>重启 MySQL 服务：</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">systemctl</span> <span class=\"selector-tag\">restart</span> <span class=\"selector-tag\">mysqld</span><span class=\"selector-class\">.service</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置主从同步\"><a href=\"#配置主从同步\" class=\"headerlink\" title=\"配置主从同步\"></a>配置主从同步</h5><p>停止 slave 服务进程：</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"literal\">stop</span> <span class=\"literal\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<p>配置同步上游信息：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; change master <span class=\"keyword\">to</span> </span><br><span class=\"line\"><span class=\"attribute\">master_host</span>=<span class=\"string\">&#x27;13.75.108.150&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_user</span>=<span class=\"string\">&#x27;slave&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_password</span>=<span class=\"string\">&#x27;&#123;YOUR PASSWORD&#125;&#x27;</span>,</span><br><span class=\"line\"><span class=\"attribute\">master_log_file</span>=<span class=\"string\">&#x27;mysql-bin.000001&#x27;</span>, </span><br><span class=\"line\"><span class=\"attribute\">master_log_pos</span>=313;</span><br></pre></td></tr></table></figure>\n\n<p>开启 slave 服务进程：</p>\n<figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; <span class=\"literal\">start</span> <span class=\"literal\">slave</span>;</span><br></pre></td></tr></table></figure>\n\n<p>查看 slave 同步状态：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mysql&gt;</span> <span class=\"string\">show</span> <span class=\"string\">slave</span> <span class=\"string\">status\\G;</span></span><br><span class=\"line\"><span class=\"string\">***************************</span> <span class=\"number\">1</span><span class=\"string\">.</span> <span class=\"string\">row</span> <span class=\"string\">***************************</span></span><br><span class=\"line\">               <span class=\"attr\">Slave_IO_State:</span> <span class=\"string\">Waiting</span> <span class=\"string\">for</span> <span class=\"string\">master</span> <span class=\"string\">to</span> <span class=\"string\">send</span> <span class=\"string\">event</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Host:</span> <span class=\"number\">13.75</span><span class=\"number\">.108</span><span class=\"number\">.150</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_User:</span> <span class=\"string\">slave</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">                <span class=\"attr\">Connect_Retry:</span> <span class=\"number\">60</span></span><br><span class=\"line\">              <span class=\"attr\">Master_Log_File:</span> <span class=\"string\">mysql-bin.000001</span></span><br><span class=\"line\">          <span class=\"attr\">Read_Master_Log_Pos:</span> <span class=\"number\">1064</span></span><br><span class=\"line\">               <span class=\"attr\">Relay_Log_File:</span> <span class=\"string\">slave-relay-bin.000002</span></span><br><span class=\"line\">                <span class=\"attr\">Relay_Log_Pos:</span> <span class=\"number\">1071</span></span><br><span class=\"line\">        <span class=\"attr\">Relay_Master_Log_File:</span> <span class=\"string\">mysql-bin.000001</span></span><br><span class=\"line\">             <span class=\"attr\">Slave_IO_Running:</span> <span class=\"literal\">Yes</span></span><br><span class=\"line\">            <span class=\"attr\">Slave_SQL_Running:</span> <span class=\"literal\">Yes</span></span><br><span class=\"line\">              <span class=\"attr\">Replicate_Do_DB:</span> <span class=\"string\">test</span></span><br><span class=\"line\">          <span class=\"attr\">Replicate_Ignore_DB:</span></span><br><span class=\"line\">           <span class=\"attr\">Replicate_Do_Table:</span></span><br><span class=\"line\">       <span class=\"attr\">Replicate_Ignore_Table:</span></span><br><span class=\"line\">      <span class=\"attr\">Replicate_Wild_Do_Table:</span></span><br><span class=\"line\">  <span class=\"attr\">Replicate_Wild_Ignore_Table:</span></span><br><span class=\"line\">                   <span class=\"attr\">Last_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">                   <span class=\"attr\">Last_Error:</span></span><br><span class=\"line\">                 <span class=\"attr\">Skip_Counter:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">Exec_Master_Log_Pos:</span> <span class=\"number\">1064</span></span><br><span class=\"line\">              <span class=\"attr\">Relay_Log_Space:</span> <span class=\"number\">1278</span></span><br><span class=\"line\">              <span class=\"attr\">Until_Condition:</span> <span class=\"string\">None</span></span><br><span class=\"line\">               <span class=\"attr\">Until_Log_File:</span></span><br><span class=\"line\">                <span class=\"attr\">Until_Log_Pos:</span> <span class=\"number\">0</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_Allowed:</span> <span class=\"literal\">No</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_CA_File:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_CA_Path:</span></span><br><span class=\"line\">              <span class=\"attr\">Master_SSL_Cert:</span></span><br><span class=\"line\">            <span class=\"attr\">Master_SSL_Cipher:</span></span><br><span class=\"line\">               <span class=\"attr\">Master_SSL_Key:</span></span><br><span class=\"line\">        <span class=\"attr\">Seconds_Behind_Master:</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">Master_SSL_Verify_Server_Cert:</span> <span class=\"literal\">No</span></span><br><span class=\"line\">                <span class=\"attr\">Last_IO_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">                <span class=\"attr\">Last_IO_Error:</span></span><br><span class=\"line\">               <span class=\"attr\">Last_SQL_Errno:</span> <span class=\"number\">0</span></span><br><span class=\"line\">               <span class=\"attr\">Last_SQL_Error:</span></span><br><span class=\"line\">  <span class=\"attr\">Replicate_Ignore_Server_Ids:</span></span><br><span class=\"line\">             <span class=\"attr\">Master_Server_Id:</span> <span class=\"number\">10</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_UUID:</span> <span class=\"string\">8c019b28-306a-11ea-80a3-000d3a8507a5</span></span><br><span class=\"line\">             <span class=\"attr\">Master_Info_File:</span> <span class=\"string\">/var/lib/mysql/master.info</span></span><br><span class=\"line\">                    <span class=\"attr\">SQL_Delay:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">SQL_Remaining_Delay:</span> <span class=\"literal\">NULL</span></span><br><span class=\"line\">      <span class=\"attr\">Slave_SQL_Running_State:</span> <span class=\"string\">Slave</span> <span class=\"string\">has</span> <span class=\"string\">read</span> <span class=\"string\">all</span> <span class=\"string\">relay</span> <span class=\"string\">log;</span> <span class=\"string\">waiting</span> <span class=\"string\">for</span> <span class=\"string\">more</span> <span class=\"string\">updates</span></span><br><span class=\"line\">           <span class=\"attr\">Master_Retry_Count:</span> <span class=\"number\">86400</span></span><br><span class=\"line\">                  <span class=\"attr\">Master_Bind:</span></span><br><span class=\"line\">      <span class=\"attr\">Last_IO_Error_Timestamp:</span></span><br><span class=\"line\">     <span class=\"attr\">Last_SQL_Error_Timestamp:</span></span><br><span class=\"line\">               <span class=\"attr\">Master_SSL_Crl:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_SSL_Crlpath:</span></span><br><span class=\"line\">           <span class=\"attr\">Retrieved_Gtid_Set:</span></span><br><span class=\"line\">            <span class=\"attr\">Executed_Gtid_Set:</span></span><br><span class=\"line\">                <span class=\"attr\">Auto_Position:</span> <span class=\"number\">0</span></span><br><span class=\"line\">         <span class=\"attr\">Replicate_Rewrite_DB:</span></span><br><span class=\"line\">                 <span class=\"attr\">Channel_Name:</span></span><br><span class=\"line\">           <span class=\"attr\">Master_TLS_Version:</span></span><br></pre></td></tr></table></figure>"},{"title":"Win10 使用 Kind 部署 Kubernetes","date":"2020-11-01T10:16:28.000Z","_content":"\n## 背景\nWin10 的 WSL2 支撑了在 Linux 子系统中使用 Docker，尝试在 WSL2 环境下通过 [Kind](https://github.com/kubernetes-sigs/kind) 来部署本地 Kubernetes 环境。\n\n## 操作步骤\n\n### WSL2 安装\n详细文档参考 [Installation Instructions for WSL2](https://docs.microsoft.com/en-us/windows/wsl/install-win10)\n1. 在Windows程序中，选择启用 \"适用于 Linux 的 Windows 子系统\"\n2. 管理员身份打开 PowerShell 并运行 `dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart`\n3. 管理员身份打开 PowerShell 并运行 `wsl --set-default-version 2`\n4. 打开 Microsoft Store，并选择自己偏好的 Linux 分发版\n\n### Docker-desktop 安装\n文档参考 [docker-for-windows](https://docs.docker.com/docker-for-windows/wsl/) 进行 Win10 Docker-desktop 安装\n\n### Kind 安装\n1. 进入 Win10 的 Linux 子系统，在子系统内安装 Kind binary\n```\ncurl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64\nchmod +x ./kind\nmv ./kind /some-dir-in-your-PATH/kind\n```\n2. 准备 Kind 所需的 kindest/node 镜像 `docker pull kindest/node:v1.19.1`\n3. 使用 Kind 命令创建本地 Kubernetes `kind create cluster`\n```\nCreating cluster \"kind\" ...\n ✓ Ensuring node image (kindest/node:v1.19.1) 🖼\n ✓ Preparing nodes 📦\n ✓ Writing configuration 📜\n ✓ Starting control-plane 🕹️\n ✓ Installing CNI 🔌\n ✓ Installing StorageClass 💾\nSet kubectl context to \"kind-kind\"\nYou can now use your cluster with:\n\nkubectl cluster-info --context kind-kind\n\nThanks for using kind! 😊\n```\n4. 使用 kubectl 部署 deployment `kubectl create deployment nginx --image=nginx`\n```\nNAME    READY   UP-TO-DATE   AVAILABLE   AGE\nnginx   1/1     1            0           63s\n```","source":"_posts/Win10-使用-Kind-部署-Kubernetes.md","raw":"---\ntitle: Win10 使用 Kind 部署 Kubernetes\ndate: 2020-11-01 18:16:28\ntags:\n\t- Kubernetes\n\t- Kind\n---\n\n## 背景\nWin10 的 WSL2 支撑了在 Linux 子系统中使用 Docker，尝试在 WSL2 环境下通过 [Kind](https://github.com/kubernetes-sigs/kind) 来部署本地 Kubernetes 环境。\n\n## 操作步骤\n\n### WSL2 安装\n详细文档参考 [Installation Instructions for WSL2](https://docs.microsoft.com/en-us/windows/wsl/install-win10)\n1. 在Windows程序中，选择启用 \"适用于 Linux 的 Windows 子系统\"\n2. 管理员身份打开 PowerShell 并运行 `dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart`\n3. 管理员身份打开 PowerShell 并运行 `wsl --set-default-version 2`\n4. 打开 Microsoft Store，并选择自己偏好的 Linux 分发版\n\n### Docker-desktop 安装\n文档参考 [docker-for-windows](https://docs.docker.com/docker-for-windows/wsl/) 进行 Win10 Docker-desktop 安装\n\n### Kind 安装\n1. 进入 Win10 的 Linux 子系统，在子系统内安装 Kind binary\n```\ncurl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64\nchmod +x ./kind\nmv ./kind /some-dir-in-your-PATH/kind\n```\n2. 准备 Kind 所需的 kindest/node 镜像 `docker pull kindest/node:v1.19.1`\n3. 使用 Kind 命令创建本地 Kubernetes `kind create cluster`\n```\nCreating cluster \"kind\" ...\n ✓ Ensuring node image (kindest/node:v1.19.1) 🖼\n ✓ Preparing nodes 📦\n ✓ Writing configuration 📜\n ✓ Starting control-plane 🕹️\n ✓ Installing CNI 🔌\n ✓ Installing StorageClass 💾\nSet kubectl context to \"kind-kind\"\nYou can now use your cluster with:\n\nkubectl cluster-info --context kind-kind\n\nThanks for using kind! 😊\n```\n4. 使用 kubectl 部署 deployment `kubectl create deployment nginx --image=nginx`\n```\nNAME    READY   UP-TO-DATE   AVAILABLE   AGE\nnginx   1/1     1            0           63s\n```","slug":"Win10-使用-Kind-部署-Kubernetes","published":1,"updated":"2020-11-01T13:01:40.620Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckh8rn35s0006y9fohdbt0ym0","content":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>Win10 的 WSL2 支撑了在 Linux 子系统中使用 Docker，尝试在 WSL2 环境下通过 <a href=\"https://github.com/kubernetes-sigs/kind\">Kind</a> 来部署本地 Kubernetes 环境。</p>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"WSL2-安装\"><a href=\"#WSL2-安装\" class=\"headerlink\" title=\"WSL2 安装\"></a>WSL2 安装</h3><p>详细文档参考 <a href=\"https://docs.microsoft.com/en-us/windows/wsl/install-win10\">Installation Instructions for WSL2</a></p>\n<ol>\n<li>在Windows程序中，选择启用 “适用于 Linux 的 Windows 子系统”</li>\n<li>管理员身份打开 PowerShell 并运行 <code>dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart</code></li>\n<li>管理员身份打开 PowerShell 并运行 <code>wsl --set-default-version 2</code></li>\n<li>打开 Microsoft Store，并选择自己偏好的 Linux 分发版</li>\n</ol>\n<h3 id=\"Docker-desktop-安装\"><a href=\"#Docker-desktop-安装\" class=\"headerlink\" title=\"Docker-desktop 安装\"></a>Docker-desktop 安装</h3><p>文档参考 <a href=\"https://docs.docker.com/docker-for-windows/wsl/\">docker-for-windows</a> 进行 Win10 Docker-desktop 安装</p>\n<h3 id=\"Kind-安装\"><a href=\"#Kind-安装\" class=\"headerlink\" title=\"Kind 安装\"></a>Kind 安装</h3><ol>\n<li>进入 Win10 的 Linux 子系统，在子系统内安装 Kind binary<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -Lo .<span class=\"regexp\">/kind https:/</span><span class=\"regexp\">/kind.sigs.k8s.io/</span>dl<span class=\"regexp\">/v0.9.0/</span>kind-linux-amd64</span><br><span class=\"line\">chmod +x ./kind</span><br><span class=\"line\">mv .<span class=\"regexp\">/kind /</span>some-dir-<span class=\"keyword\">in</span>-your-PATH/kind</span><br></pre></td></tr></table></figure></li>\n<li>准备 Kind 所需的 kindest/node 镜像 <code>docker pull kindest/node:v1.19.1</code></li>\n<li>使用 Kind 命令创建本地 Kubernetes <code>kind create cluster</code><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Creating cluster <span class=\"string\">&quot;kind&quot;</span> ...</span><br><span class=\"line\"> ✓ Ensuring <span class=\"keyword\">node</span> <span class=\"title\">image</span> (kindest/<span class=\"keyword\">node</span><span class=\"title\">:v1</span>.<span class=\"number\">19.1</span>) 🖼</span><br><span class=\"line\"> ✓ Preparing nodes 📦</span><br><span class=\"line\"> ✓ Writing configuration 📜</span><br><span class=\"line\"> ✓ Starting control-plane 🕹️</span><br><span class=\"line\"> ✓ Installing CNI 🔌</span><br><span class=\"line\"> ✓ Installing StorageClass 💾</span><br><span class=\"line\">Set kubectl context to <span class=\"string\">&quot;kind-kind&quot;</span></span><br><span class=\"line\">You can now use your cluster with:</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl cluster<span class=\"literal\">-inf</span>o --context kind-kind</span><br><span class=\"line\"></span><br><span class=\"line\">Thanks for using kind! 😊</span><br></pre></td></tr></table></figure></li>\n<li>使用 kubectl 部署 deployment <code>kubectl create deployment nginx --image=nginx</code><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">nginx   <span class=\"number\">1</span>/<span class=\"number\">1</span>     <span class=\"number\">1</span>            <span class=\"number\">0</span>           <span class=\"number\">63</span>s</span><br></pre></td></tr></table></figure></li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>Win10 的 WSL2 支撑了在 Linux 子系统中使用 Docker，尝试在 WSL2 环境下通过 <a href=\"https://github.com/kubernetes-sigs/kind\">Kind</a> 来部署本地 Kubernetes 环境。</p>\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"WSL2-安装\"><a href=\"#WSL2-安装\" class=\"headerlink\" title=\"WSL2 安装\"></a>WSL2 安装</h3><p>详细文档参考 <a href=\"https://docs.microsoft.com/en-us/windows/wsl/install-win10\">Installation Instructions for WSL2</a></p>\n<ol>\n<li>在Windows程序中，选择启用 “适用于 Linux 的 Windows 子系统”</li>\n<li>管理员身份打开 PowerShell 并运行 <code>dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart</code></li>\n<li>管理员身份打开 PowerShell 并运行 <code>wsl --set-default-version 2</code></li>\n<li>打开 Microsoft Store，并选择自己偏好的 Linux 分发版</li>\n</ol>\n<h3 id=\"Docker-desktop-安装\"><a href=\"#Docker-desktop-安装\" class=\"headerlink\" title=\"Docker-desktop 安装\"></a>Docker-desktop 安装</h3><p>文档参考 <a href=\"https://docs.docker.com/docker-for-windows/wsl/\">docker-for-windows</a> 进行 Win10 Docker-desktop 安装</p>\n<h3 id=\"Kind-安装\"><a href=\"#Kind-安装\" class=\"headerlink\" title=\"Kind 安装\"></a>Kind 安装</h3><ol>\n<li>进入 Win10 的 Linux 子系统，在子系统内安装 Kind binary<figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -Lo .<span class=\"regexp\">/kind https:/</span><span class=\"regexp\">/kind.sigs.k8s.io/</span>dl<span class=\"regexp\">/v0.9.0/</span>kind-linux-amd64</span><br><span class=\"line\">chmod +x ./kind</span><br><span class=\"line\">mv .<span class=\"regexp\">/kind /</span>some-dir-<span class=\"keyword\">in</span>-your-PATH/kind</span><br></pre></td></tr></table></figure></li>\n<li>准备 Kind 所需的 kindest/node 镜像 <code>docker pull kindest/node:v1.19.1</code></li>\n<li>使用 Kind 命令创建本地 Kubernetes <code>kind create cluster</code><figure class=\"highlight crmsh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Creating cluster <span class=\"string\">&quot;kind&quot;</span> ...</span><br><span class=\"line\"> ✓ Ensuring <span class=\"keyword\">node</span> <span class=\"title\">image</span> (kindest/<span class=\"keyword\">node</span><span class=\"title\">:v1</span>.<span class=\"number\">19.1</span>) 🖼</span><br><span class=\"line\"> ✓ Preparing nodes 📦</span><br><span class=\"line\"> ✓ Writing configuration 📜</span><br><span class=\"line\"> ✓ Starting control-plane 🕹️</span><br><span class=\"line\"> ✓ Installing CNI 🔌</span><br><span class=\"line\"> ✓ Installing StorageClass 💾</span><br><span class=\"line\">Set kubectl context to <span class=\"string\">&quot;kind-kind&quot;</span></span><br><span class=\"line\">You can now use your cluster with:</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl cluster<span class=\"literal\">-inf</span>o --context kind-kind</span><br><span class=\"line\"></span><br><span class=\"line\">Thanks for using kind! 😊</span><br></pre></td></tr></table></figure></li>\n<li>使用 kubectl 部署 deployment <code>kubectl create deployment nginx --image=nginx</code><figure class=\"highlight angelscript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">nginx   <span class=\"number\">1</span>/<span class=\"number\">1</span>     <span class=\"number\">1</span>            <span class=\"number\">0</span>           <span class=\"number\">63</span>s</span><br></pre></td></tr></table></figure></li>\n</ol>\n"},{"title":"kubeadm 初探","date":"2020-01-06T11:18:16.000Z","_content":"\n使用 kubeadm 安装 k8s 集群步骤整理。\n\n## 示例服务器准备\n\nAzure VM 上创建三台 centos 7.5 服务器分别作为 k8s master 和 k8s worker：\n\n```\nmaster: 207.46.156.242\nworker1: 207.46.151.202\nworker2: 168.63.140.91\n```\n\n## 操作步骤\n### 安装 Docker\n\n#### 安装相关依赖\n\n```\nsudo yum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n```\n#### 添加 Docker 仓库\n\n```\nsudo yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n#### 安装 Docker \n\n```\nsudo yum install docker-ce docker-ce-cli containerd.io\n```\n\n#### 启动 Docker\n\n```\nsudo systemctl start docker\n\nsudo systemctl enable docker\n```\n\n### 安装 kubeadm\n\n#### 安装 kubeadm , kubelet , kubectl\n\n```\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n\n# Set SELinux in permissive mode (effectively disabling it)\nsetenforce 0\nsed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\nyum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n\nsystemctl enable --now kubelet\n```\n\n#### 修改 Docker cgroups 启动\n\n创建 `/etc/docker/daemon.json` 文件，加入以下内容\n\n```\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\n```\n重启 Docker\n\n```\nsystemctl restart docker\n```\n\n查看修改后状态\n\n```\ndocker info | grep Cgroup\n\nCgroup Driver: systemd\n```\n\n#### 配置 bridge \n\n```\necho 1 > /proc/sys/net/bridge/bridge-nf-call-iptables\necho 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables\n```\n\n### 使用 kubeadm 部署 k8s 集群\n\n#### master 节点\n\n##### 执行初始化命令\n\n```\nkubeadm init\n```\n\n##### 记录 join 参数命令\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\n##### 执行集群配置命令\n\n```\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n##### 部署网络插件\n\n```\nkubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n```\n\n#### worker 节点\n\n分别执行 join 命令\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\n在 master 节点上查看 node 状态\n\n```\nkubectl get nodes\n\nNAME       STATUS   ROLES    AGE     VERSION\nmaster     Ready    master   8m45s   v1.17.0\nworker01   Ready    <none>   2m31s   v1.17.0\nworker02   Ready    <none>   2m23s   v1.17.0\n```\n\n\n\n\n\n\n","source":"_posts/kubeadm-初探.md","raw":"---\ntitle: kubeadm 初探\ndate: 2020-01-06 19:18:16\ntags:\n\t- k8s\n\t- kubeadm\n---\n\n使用 kubeadm 安装 k8s 集群步骤整理。\n\n## 示例服务器准备\n\nAzure VM 上创建三台 centos 7.5 服务器分别作为 k8s master 和 k8s worker：\n\n```\nmaster: 207.46.156.242\nworker1: 207.46.151.202\nworker2: 168.63.140.91\n```\n\n## 操作步骤\n### 安装 Docker\n\n#### 安装相关依赖\n\n```\nsudo yum install -y yum-utils \\\n  device-mapper-persistent-data \\\n  lvm2\n```\n#### 添加 Docker 仓库\n\n```\nsudo yum-config-manager \\\n    --add-repo \\\n    https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n#### 安装 Docker \n\n```\nsudo yum install docker-ce docker-ce-cli containerd.io\n```\n\n#### 启动 Docker\n\n```\nsudo systemctl start docker\n\nsudo systemctl enable docker\n```\n\n### 安装 kubeadm\n\n#### 安装 kubeadm , kubelet , kubectl\n\n```\ncat <<EOF > /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n\n# Set SELinux in permissive mode (effectively disabling it)\nsetenforce 0\nsed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\nyum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n\nsystemctl enable --now kubelet\n```\n\n#### 修改 Docker cgroups 启动\n\n创建 `/etc/docker/daemon.json` 文件，加入以下内容\n\n```\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"]\n}\n```\n重启 Docker\n\n```\nsystemctl restart docker\n```\n\n查看修改后状态\n\n```\ndocker info | grep Cgroup\n\nCgroup Driver: systemd\n```\n\n#### 配置 bridge \n\n```\necho 1 > /proc/sys/net/bridge/bridge-nf-call-iptables\necho 1 > /proc/sys/net/bridge/bridge-nf-call-ip6tables\n```\n\n### 使用 kubeadm 部署 k8s 集群\n\n#### master 节点\n\n##### 执行初始化命令\n\n```\nkubeadm init\n```\n\n##### 记录 join 参数命令\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\n##### 执行集群配置命令\n\n```\nmkdir -p $HOME/.kube\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\n```\n\n##### 部署网络插件\n\n```\nkubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"\n```\n\n#### worker 节点\n\n分别执行 join 命令\n\n```\nkubeadm join 10.0.1.4:6443 --token mv7ql6.zvcdldux0io1kspb \\\n    --discovery-token-ca-cert-hash sha256:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc\n```\n\n在 master 节点上查看 node 状态\n\n```\nkubectl get nodes\n\nNAME       STATUS   ROLES    AGE     VERSION\nmaster     Ready    master   8m45s   v1.17.0\nworker01   Ready    <none>   2m31s   v1.17.0\nworker02   Ready    <none>   2m23s   v1.17.0\n```\n\n\n\n\n\n\n","slug":"kubeadm-初探","published":1,"updated":"2020-11-08T06:55:59.840Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckh8rn35t0007y9fo7hoz1is8","content":"<p>使用 kubeadm 安装 k8s 集群步骤整理。</p>\n<h2 id=\"示例服务器准备\"><a href=\"#示例服务器准备\" class=\"headerlink\" title=\"示例服务器准备\"></a>示例服务器准备</h2><p>Azure VM 上创建三台 centos 7.5 服务器分别作为 k8s master 和 k8s worker：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">master:</span> <span class=\"number\">207.46</span><span class=\"number\">.156</span><span class=\"number\">.242</span></span><br><span class=\"line\"><span class=\"attr\">worker1:</span> <span class=\"number\">207.46</span><span class=\"number\">.151</span><span class=\"number\">.202</span></span><br><span class=\"line\"><span class=\"attr\">worker2:</span> <span class=\"number\">168.63</span><span class=\"number\">.140</span><span class=\"number\">.91</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"安装-Docker\"><a href=\"#安装-Docker\" class=\"headerlink\" title=\"安装 Docker\"></a>安装 Docker</h3><h4 id=\"安装相关依赖\"><a href=\"#安装相关依赖\" class=\"headerlink\" title=\"安装相关依赖\"></a>安装相关依赖</h4><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">sudo</span> <span class=\"string\">yum install -y yum-utils \\</span></span><br><span class=\"line\">  <span class=\"meta\">device-mapper-persistent-data</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"attr\">lvm2</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"添加-Docker-仓库\"><a href=\"#添加-Docker-仓库\" class=\"headerlink\" title=\"添加 Docker 仓库\"></a>添加 Docker 仓库</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum-config-manager \\</span><br><span class=\"line\">    --add-repo \\</span><br><span class=\"line\">    https:<span class=\"regexp\">//</span>download.docker.com<span class=\"regexp\">/linux/</span>centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装-Docker-1\"><a href=\"#安装-Docker-1\" class=\"headerlink\" title=\"安装 Docker\"></a>安装 Docker</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install docker-<span class=\"keyword\">ce</span> docker-<span class=\"keyword\">ce</span>-cli containerd.io</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"启动-Docker\"><a href=\"#启动-Docker\" class=\"headerlink\" title=\"启动 Docker\"></a>启动 Docker</h4><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"keyword\">start</span> docker</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl <span class=\"keyword\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装-kubeadm\"><a href=\"#安装-kubeadm\" class=\"headerlink\" title=\"安装 kubeadm\"></a>安装 kubeadm</h3><h4 id=\"安装-kubeadm-kubelet-kubectl\"><a href=\"#安装-kubeadm-kubelet-kubectl\" class=\"headerlink\" title=\"安装 kubeadm , kubelet , kubectl\"></a>安装 kubeadm , kubelet , kubectl</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF &gt; <span class=\"regexp\">/etc/yum</span>.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https:<span class=\"regexp\">//</span>packages.cloud.google.com<span class=\"regexp\">/yum/</span>repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=<span class=\"number\">1</span></span><br><span class=\"line\">gpgcheck=<span class=\"number\">1</span></span><br><span class=\"line\">repo_gpgcheck=<span class=\"number\">1</span></span><br><span class=\"line\">gpgkey=https:<span class=\"regexp\">//</span>packages.cloud.google.com<span class=\"regexp\">/yum/</span>doc<span class=\"regexp\">/yum-key.gpg https:/</span><span class=\"regexp\">/packages.cloud.google.com/yum</span><span class=\"regexp\">/doc/</span>rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set SELinux in permissive mode (effectively disabling it)</span></span><br><span class=\"line\">setenforce <span class=\"number\">0</span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> <span class=\"regexp\">/etc/</span>selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改-Docker-cgroups-启动\"><a href=\"#修改-Docker-cgroups-启动\" class=\"headerlink\" title=\"修改 Docker cgroups 启动\"></a>修改 Docker cgroups 启动</h4><p>创建 <code>/etc/docker/daemon.json</code> 文件，加入以下内容</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;exec-opts&quot;</span>: [<span class=\"string\">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>重启 Docker</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">systemctl restart docker</span></span><br></pre></td></tr></table></figure>\n\n<p>查看修改后状态</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">docker</span> <span class=\"literal\">info</span> | grep Cgroup</span><br><span class=\"line\"></span><br><span class=\"line\">Cgroup Driver: systemd</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置-bridge\"><a href=\"#配置-bridge\" class=\"headerlink\" title=\"配置 bridge\"></a>配置 bridge</h4><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo <span class=\"number\">1</span> &gt; <span class=\"regexp\">/proc/</span>sys<span class=\"regexp\">/net/</span>bridge/bridge-nf-<span class=\"keyword\">call</span>-iptables</span><br><span class=\"line\">echo <span class=\"number\">1</span> &gt; <span class=\"regexp\">/proc/</span>sys<span class=\"regexp\">/net/</span>bridge/bridge-nf-<span class=\"keyword\">call</span>-ip6tables</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-kubeadm-部署-k8s-集群\"><a href=\"#使用-kubeadm-部署-k8s-集群\" class=\"headerlink\" title=\"使用 kubeadm 部署 k8s 集群\"></a>使用 kubeadm 部署 k8s 集群</h3><h4 id=\"master-节点\"><a href=\"#master-节点\" class=\"headerlink\" title=\"master 节点\"></a>master 节点</h4><h5 id=\"执行初始化命令\"><a href=\"#执行初始化命令\" class=\"headerlink\" title=\"执行初始化命令\"></a>执行初始化命令</h5><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"keyword\">init</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"记录-join-参数命令\"><a href=\"#记录-join-参数命令\" class=\"headerlink\" title=\"记录 join 参数命令\"></a>记录 join 参数命令</h5><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubeadm</span> <span class=\"selector-tag\">join</span> 10<span class=\"selector-class\">.0</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.4</span><span class=\"selector-pseudo\">:6443</span> <span class=\"selector-tag\">--token</span> <span class=\"selector-tag\">mv7ql6</span><span class=\"selector-class\">.zvcdldux0io1kspb</span> \\</span><br><span class=\"line\">    <span class=\"selector-tag\">--discovery-token-ca-cert-hash</span> <span class=\"selector-tag\">sha256</span><span class=\"selector-pseudo\">:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"执行集群配置命令\"><a href=\"#执行集群配置命令\" class=\"headerlink\" title=\"执行集群配置命令\"></a>执行集群配置命令</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"部署网络插件\"><a href=\"#部署网络插件\" class=\"headerlink\" title=\"部署网络插件\"></a>部署网络插件</h5><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply <span class=\"operator\">-f</span> <span class=\"string\">&quot;https://cloud.weave.works/k8s/net?k8s-version=<span class=\"variable\">$</span>(kubectl version | base64 | tr -d &#x27;\\n&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"worker-节点\"><a href=\"#worker-节点\" class=\"headerlink\" title=\"worker 节点\"></a>worker 节点</h4><p>分别执行 join 命令</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubeadm</span> <span class=\"selector-tag\">join</span> 10<span class=\"selector-class\">.0</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.4</span><span class=\"selector-pseudo\">:6443</span> <span class=\"selector-tag\">--token</span> <span class=\"selector-tag\">mv7ql6</span><span class=\"selector-class\">.zvcdldux0io1kspb</span> \\</span><br><span class=\"line\">    <span class=\"selector-tag\">--discovery-token-ca-cert-hash</span> <span class=\"selector-tag\">sha256</span><span class=\"selector-pseudo\">:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc</span></span><br></pre></td></tr></table></figure>\n\n<p>在 master 节点上查看 node 状态</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl</span> get nodes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">NAME</span>       STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\"><span class=\"attribute\">master</span>     Ready    master   <span class=\"number\">8</span>m<span class=\"number\">45</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attribute\">worker01</span>   Ready    &lt;none&gt;   <span class=\"number\">2</span>m<span class=\"number\">31</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attribute\">worker02</span>   Ready    &lt;none&gt;   <span class=\"number\">2</span>m<span class=\"number\">23</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<p>使用 kubeadm 安装 k8s 集群步骤整理。</p>\n<h2 id=\"示例服务器准备\"><a href=\"#示例服务器准备\" class=\"headerlink\" title=\"示例服务器准备\"></a>示例服务器准备</h2><p>Azure VM 上创建三台 centos 7.5 服务器分别作为 k8s master 和 k8s worker：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">master:</span> <span class=\"number\">207.46</span><span class=\"number\">.156</span><span class=\"number\">.242</span></span><br><span class=\"line\"><span class=\"attr\">worker1:</span> <span class=\"number\">207.46</span><span class=\"number\">.151</span><span class=\"number\">.202</span></span><br><span class=\"line\"><span class=\"attr\">worker2:</span> <span class=\"number\">168.63</span><span class=\"number\">.140</span><span class=\"number\">.91</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"操作步骤\"><a href=\"#操作步骤\" class=\"headerlink\" title=\"操作步骤\"></a>操作步骤</h2><h3 id=\"安装-Docker\"><a href=\"#安装-Docker\" class=\"headerlink\" title=\"安装 Docker\"></a>安装 Docker</h3><h4 id=\"安装相关依赖\"><a href=\"#安装相关依赖\" class=\"headerlink\" title=\"安装相关依赖\"></a>安装相关依赖</h4><figure class=\"highlight properties\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">sudo</span> <span class=\"string\">yum install -y yum-utils \\</span></span><br><span class=\"line\">  <span class=\"meta\">device-mapper-persistent-data</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"attr\">lvm2</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"添加-Docker-仓库\"><a href=\"#添加-Docker-仓库\" class=\"headerlink\" title=\"添加 Docker 仓库\"></a>添加 Docker 仓库</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum-config-manager \\</span><br><span class=\"line\">    --add-repo \\</span><br><span class=\"line\">    https:<span class=\"regexp\">//</span>download.docker.com<span class=\"regexp\">/linux/</span>centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装-Docker-1\"><a href=\"#安装-Docker-1\" class=\"headerlink\" title=\"安装 Docker\"></a>安装 Docker</h4><figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install docker-<span class=\"keyword\">ce</span> docker-<span class=\"keyword\">ce</span>-cli containerd.io</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"启动-Docker\"><a href=\"#启动-Docker\" class=\"headerlink\" title=\"启动 Docker\"></a>启动 Docker</h4><figure class=\"highlight pgsql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl <span class=\"keyword\">start</span> docker</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl <span class=\"keyword\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装-kubeadm\"><a href=\"#安装-kubeadm\" class=\"headerlink\" title=\"安装 kubeadm\"></a>安装 kubeadm</h3><h4 id=\"安装-kubeadm-kubelet-kubectl\"><a href=\"#安装-kubeadm-kubelet-kubectl\" class=\"headerlink\" title=\"安装 kubeadm , kubelet , kubectl\"></a>安装 kubeadm , kubelet , kubectl</h4><figure class=\"highlight awk\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF &gt; <span class=\"regexp\">/etc/yum</span>.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https:<span class=\"regexp\">//</span>packages.cloud.google.com<span class=\"regexp\">/yum/</span>repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=<span class=\"number\">1</span></span><br><span class=\"line\">gpgcheck=<span class=\"number\">1</span></span><br><span class=\"line\">repo_gpgcheck=<span class=\"number\">1</span></span><br><span class=\"line\">gpgkey=https:<span class=\"regexp\">//</span>packages.cloud.google.com<span class=\"regexp\">/yum/</span>doc<span class=\"regexp\">/yum-key.gpg https:/</span><span class=\"regexp\">/packages.cloud.google.com/yum</span><span class=\"regexp\">/doc/</span>rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set SELinux in permissive mode (effectively disabling it)</span></span><br><span class=\"line\">setenforce <span class=\"number\">0</span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27;</span> <span class=\"regexp\">/etc/</span>selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改-Docker-cgroups-启动\"><a href=\"#修改-Docker-cgroups-启动\" class=\"headerlink\" title=\"修改 Docker cgroups 启动\"></a>修改 Docker cgroups 启动</h4><p>创建 <code>/etc/docker/daemon.json</code> 文件，加入以下内容</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;exec-opts&quot;</span>: [<span class=\"string\">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>重启 Docker</p>\n<figure class=\"highlight ebnf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">systemctl restart docker</span></span><br></pre></td></tr></table></figure>\n\n<p>查看修改后状态</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">docker</span> <span class=\"literal\">info</span> | grep Cgroup</span><br><span class=\"line\"></span><br><span class=\"line\">Cgroup Driver: systemd</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"配置-bridge\"><a href=\"#配置-bridge\" class=\"headerlink\" title=\"配置 bridge\"></a>配置 bridge</h4><figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo <span class=\"number\">1</span> &gt; <span class=\"regexp\">/proc/</span>sys<span class=\"regexp\">/net/</span>bridge/bridge-nf-<span class=\"keyword\">call</span>-iptables</span><br><span class=\"line\">echo <span class=\"number\">1</span> &gt; <span class=\"regexp\">/proc/</span>sys<span class=\"regexp\">/net/</span>bridge/bridge-nf-<span class=\"keyword\">call</span>-ip6tables</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-kubeadm-部署-k8s-集群\"><a href=\"#使用-kubeadm-部署-k8s-集群\" class=\"headerlink\" title=\"使用 kubeadm 部署 k8s 集群\"></a>使用 kubeadm 部署 k8s 集群</h3><h4 id=\"master-节点\"><a href=\"#master-节点\" class=\"headerlink\" title=\"master 节点\"></a>master 节点</h4><h5 id=\"执行初始化命令\"><a href=\"#执行初始化命令\" class=\"headerlink\" title=\"执行初始化命令\"></a>执行初始化命令</h5><figure class=\"highlight csharp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"keyword\">init</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"记录-join-参数命令\"><a href=\"#记录-join-参数命令\" class=\"headerlink\" title=\"记录 join 参数命令\"></a>记录 join 参数命令</h5><figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubeadm</span> <span class=\"selector-tag\">join</span> 10<span class=\"selector-class\">.0</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.4</span><span class=\"selector-pseudo\">:6443</span> <span class=\"selector-tag\">--token</span> <span class=\"selector-tag\">mv7ql6</span><span class=\"selector-class\">.zvcdldux0io1kspb</span> \\</span><br><span class=\"line\">    <span class=\"selector-tag\">--discovery-token-ca-cert-hash</span> <span class=\"selector-tag\">sha256</span><span class=\"selector-pseudo\">:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"执行集群配置命令\"><a href=\"#执行集群配置命令\" class=\"headerlink\" title=\"执行集群配置命令\"></a>执行集群配置命令</h5><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"部署网络插件\"><a href=\"#部署网络插件\" class=\"headerlink\" title=\"部署网络插件\"></a>部署网络插件</h5><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply <span class=\"operator\">-f</span> <span class=\"string\">&quot;https://cloud.weave.works/k8s/net?k8s-version=<span class=\"variable\">$</span>(kubectl version | base64 | tr -d &#x27;\\n&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"worker-节点\"><a href=\"#worker-节点\" class=\"headerlink\" title=\"worker 节点\"></a>worker 节点</h4><p>分别执行 join 命令</p>\n<figure class=\"highlight css\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">kubeadm</span> <span class=\"selector-tag\">join</span> 10<span class=\"selector-class\">.0</span><span class=\"selector-class\">.1</span><span class=\"selector-class\">.4</span><span class=\"selector-pseudo\">:6443</span> <span class=\"selector-tag\">--token</span> <span class=\"selector-tag\">mv7ql6</span><span class=\"selector-class\">.zvcdldux0io1kspb</span> \\</span><br><span class=\"line\">    <span class=\"selector-tag\">--discovery-token-ca-cert-hash</span> <span class=\"selector-tag\">sha256</span><span class=\"selector-pseudo\">:45746646f0f96bff66d66bd28a16312df3c6864f04fab58a7442609e3c207ddc</span></span><br></pre></td></tr></table></figure>\n\n<p>在 master 节点上查看 node 状态</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">kubectl</span> get nodes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">NAME</span>       STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\"><span class=\"attribute\">master</span>     Ready    master   <span class=\"number\">8</span>m<span class=\"number\">45</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attribute\">worker01</span>   Ready    &lt;none&gt;   <span class=\"number\">2</span>m<span class=\"number\">31</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attribute\">worker02</span>   Ready    &lt;none&gt;   <span class=\"number\">2</span>m<span class=\"number\">23</span>s   v<span class=\"number\">1</span>.<span class=\"number\">17</span>.<span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"ckh8rn35j0001y9fo39h23pnc","tag_id":"ckh8rn35p0004y9fohe4s9y87","_id":"ckh8rn35v000ay9foarep18ro"},{"post_id":"ckh8rn35j0001y9fo39h23pnc","tag_id":"ckh8rn35u0008y9fo56503a6c","_id":"ckh8rn35v000by9fo6x8i1blw"},{"post_id":"ckh8rn35r0005y9fo87pn2omp","tag_id":"ckh8rn35u0009y9fof9off2fg","_id":"ckh8rn35w000ey9fo3b4rfvef"},{"post_id":"ckh8rn35r0005y9fo87pn2omp","tag_id":"ckh8rn35v000cy9fog38n0gtr","_id":"ckh8rn35w000fy9fo84ywcon1"},{"post_id":"ckh8rn35s0006y9fohdbt0ym0","tag_id":"ckh8rn35w000dy9fo29y84bau","_id":"ckh8rn35x000iy9fo9yph4kfw"},{"post_id":"ckh8rn35s0006y9fohdbt0ym0","tag_id":"ckh8rn35w000gy9fofnxu3bqd","_id":"ckh8rn35x000jy9foe5k1927x"},{"post_id":"ckh8rn35t0007y9fo7hoz1is8","tag_id":"ckh8rn35x000hy9fodjy71e1h","_id":"ckh8rn35x000ly9fogk9lacs2"},{"post_id":"ckh8rn35t0007y9fo7hoz1is8","tag_id":"ckh8rn35x000ky9fo80udaqug","_id":"ckh8rn35y000my9fo5vcq9dgz"}],"Tag":[{"name":"Confluence","_id":"ckh8rn35p0004y9fohe4s9y87"},{"name":"Docker","_id":"ckh8rn35u0008y9fo56503a6c"},{"name":"MySQL","_id":"ckh8rn35u0009y9fof9off2fg"},{"name":"Binlog","_id":"ckh8rn35v000cy9fog38n0gtr"},{"name":"Kubernetes","_id":"ckh8rn35w000dy9fo29y84bau"},{"name":"Kind","_id":"ckh8rn35w000gy9fofnxu3bqd"},{"name":"k8s","_id":"ckh8rn35x000hy9fodjy71e1h"},{"name":"kubeadm","_id":"ckh8rn35x000ky9fo80udaqug"}]}}